!function(i,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((i="undefined"!=typeof globalThis?globalThis:i||self).iink={})}(this,(function(i){"use strict";function __awaiter(i,s,r,n){return new(r||(r=Promise))((function(a,l){function fulfilled(i){try{step(n.next(i))}catch(i){l(i)}}function rejected(i){try{step(n.throw(i))}catch(i){l(i)}}function step(i){i.done?a(i.value):function adopt(i){return i instanceof r?i:new r((function(s){s(i)}))}(i.value).then(fulfilled,rejected)}step((n=n.apply(i,s||[])).next())}))}function __classPrivateFieldGet(i,s,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof s?i!==s||!n:!s.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(i):n?n.value:s.get(i)}function __classPrivateFieldSet(i,s,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof s?i!==s||!a:!s.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(i,r):a?a.value=r:s.set(i,r),r}"function"==typeof SuppressedError&&SuppressedError;var s,r;class Logger{constructor(i,s){this.instanceName=i,this.level=s}debug(i,...s){if("1">=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.debug(r)}}info(i,...s){if("2">=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.info(r)}}warn(i,...s){if("3">=this.level){const r={from:`${this.instanceName}.${i}`,message:s};console.warn(r)}}error(i,...s){const r={from:`${this.instanceName}.${i}`,error:s};console.error(r)}}class LoggerManager{static getLogger(i){return __classPrivateFieldGet(this,s,"f",r).has(i)||__classPrivateFieldGet(this,s,"f",r).set(i,new Logger(i,"4")),__classPrivateFieldGet(this,s,"f",r).get(i)}static setLoggerLevel(i){Object.keys(i).forEach((r=>{s.getLogger(r).level=i[r]}))}}s=LoggerManager,r={value:new Map};class DeferredPromise{constructor(){this.isFullFilled=!1,this.isPending=!0,this.promise=new Promise(((i,s)=>{this.reject=i=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,s(i)})),this.resolve=s=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,i(s)}))}))}}function computeDistance(i,s){const r=Math.hypot(s.y-i.y,s.x-i.x);return isNaN(r)?0:r}function computeAngleAxeRadian(i,s){return Math.atan2(s.y-i.y,s.x-i.x)}function scalaire(i,s){return i.x*s.x+i.y*s.y}function computeNearestPointOnSegment(i,s){const r={x:i.x-s.p1.x,y:i.y-s.p1.y},n={x:s.p2.x-s.p1.x,y:s.p2.y-s.p1.y},a=scalaire(r,n),l=scalaire(n,n),d=Math.min(1,Math.max(0,a/l));return{x:s.p1.x+n.x*d,y:s.p1.y+n.y*d}}const isVersionSuperiorOrEqual=(i,s)=>{const r=i.split("."),n=s.split(".");for(let i=0;i<n.length;i++){const s=Number(n[i]),a=Number(r[i]);if(s>a)return!1;if(s<a)return!0}return!0};function computeHmac(i,s,r){return __awaiter(this,void 0,void 0,(function*(){const n=new TextEncoder,a=n.encode(i),l=n.encode(s+r),d=yield crypto.subtle.importKey("raw",l,{name:"HMAC",hash:{name:"SHA-512"}},!1,["sign"]),c=yield crypto.subtle.sign("HMAC",d,a),h=new Uint8Array(c);return Array.prototype.map.call(h,(i=>i.toString(16).padStart(2,"0"))).join("")}))}function convertMillimeterToPixel(i){return 96*i/25.4}function createUUID(){let i=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(s){const r=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==s?r:3&r|8).toString(16)}))}const mergeDeep=(i,...s)=>{const isObject=i=>i&&"object"==typeof i&&!Array.isArray(i);if(!s.length)return i;const r=s.shift();if(isObject(i)&&isObject(r))for(const s in r)isObject(r[s])?(i[s]||Object.assign(i,{[s]:{}}),mergeDeep(i[s],r[s])):Array.isArray(i[s])&&Array.isArray(r[s])?i[s].concat(r[s]):Object.assign(i,{[s]:r[s]});else Array.isArray(i)&&Array.isArray(r)?i=i.concat(r):r&&(i=r);return mergeDeep(i,...s)};function computeLinksPointers(i,s,r){const n=i.p*r;return[{x:i.x-Math.sin(s)*n,y:i.y+Math.cos(s)*n},{x:i.x+Math.sin(s)*n,y:i.y-Math.cos(s)*n}]}function computeMiddlePointer(i,s){return{x:(s.x+i.x)/2,y:(s.y+i.y)/2,p:(s.p+i.p)/2,t:(s.t+i.t)/2}}const n={capture:!1,passive:!0},a={listenerOptions:n,xyFloatPrecision:0,timestampFloatPrecision:0},l={"erase-precisely":!1},d={"match-text-size":!0},c={convert:d,eraser:l,mimeTypes:["application/vnd.myscript.jiix"]},h={"bounding-box":!1,strokes:!1,text:{chars:!1,words:!0}},p={"image-resolution":300,jiix:h},v={top:20,left:10,right:10,bottom:10},u={enable:!0,"fractional-part-digits":3,"decimal-separator":".","rounding-mode":"half up","angle-unit":"deg"},f={mode:"stroke"},g={solver:u,margin:v,eraser:l,"undo-redo":f,mimeTypes:["application/vnd.myscript.jiix"]},m={text:!0,shape:!0},_={recognition:m,eraser:l},P={"draw-text-boxes":!1,"draw-image-boxes":!1},y={debug:P},x={enable:!0},w={guides:x,eraser:l,margin:v,mimeTypes:["application/vnd.myscript.jiix"]},b={force:{"on-stylesheet-change":!1}},S={diagram:c,export:p,math:g,"raw-content":_,renderer:y,text:w,type:"TEXT",alwaysConnected:!0,lang:"en_US",gesture:{enable:!0},convert:b},F={enable:!0,gap:50},G={enable:!0},E={guides:F,smartGuide:G,minHeight:100,minWidth:100},C={protocol:"WEBSOCKET",scheme:"https",host:"cloud.myscript.com",applicationKey:"",hmacKey:"",version:"2.3.0",useWindowLocation:!1,websocket:{pingEnabled:!0,pingDelay:3e4,maxPingLostCount:10,autoReconnect:!0,maxRetryCount:2,fileChunkSize:3e5}},k={exportContent:"POINTER_UP",exportContentDelay:1e3,resizeTriggerDelay:100},M={maxStackSize:100};var T;const L={server:C,recognition:S,grabber:a,rendering:E,triggers:k,"undo-redo":M};class Configuration{constructor(i){T.set(this,LoggerManager.getLogger("CONFIGURATION")),__classPrivateFieldGet(this,T,"f").info("constructor",{configuration:i}),this.grabber=JSON.parse(JSON.stringify(L.grabber)),this.recognition=JSON.parse(JSON.stringify(L.recognition)),this.rendering=JSON.parse(JSON.stringify(L.rendering)),this.server=JSON.parse(JSON.stringify(L.server)),this.triggers=JSON.parse(JSON.stringify(L.triggers)),this.overrideDefaultConfiguration(i)}overrideDefaultConfiguration(i){var s,r,n,a,l,d,c;__classPrivateFieldGet(this,T,"f").info("overrideDefaultConfiguration",{configuration:i});const h=JSON.parse(JSON.stringify(L));this.grabber=mergeDeep({},h.grabber,null==i?void 0:i.grabber),this.recognition=mergeDeep({},h.recognition,null==i?void 0:i.recognition),this.rendering=mergeDeep({},h.rendering,null==i?void 0:i.rendering),this.server=mergeDeep({},h.server,null==i?void 0:i.server),this.triggers=mergeDeep({},h.triggers,null==i?void 0:i.triggers),this["undo-redo"]=mergeDeep({},h["undo-redo"],null==i?void 0:i["undo-redo"]),this.recognition.text.mimeTypes=(null===(r=null===(s=null==i?void 0:i.recognition)||void 0===s?void 0:s.text)||void 0===r?void 0:r.mimeTypes)||h.recognition.text.mimeTypes,this.recognition.math.mimeTypes=(null===(a=null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.math)||void 0===a?void 0:a.mimeTypes)||h.recognition.math.mimeTypes,this.recognition.diagram.mimeTypes=(null===(d=null===(l=null==i?void 0:i.recognition)||void 0===l?void 0:l.diagram)||void 0===d?void 0:d.mimeTypes)||h.recognition.diagram.mimeTypes,(null===(c=this.server)||void 0===c?void 0:c.useWindowLocation)&&(this.server.scheme=window.location.protocol.indexOf("s")>-1?"https":"http",this.server.host=window.location.host),"REST"===this.server.protocol&&"POINTER_UP"===this.triggers.exportContent&&(this.triggers.exportContent="QUIET_PERIOD",this.triggers.exportContentDelay=Math.max(this.triggers.exportContentDelay,50)),"WEBSOCKET"===this.server.protocol&&"TEXT"===this.recognition.type?this.rendering.smartGuide.enable&&!this.recognition.text.mimeTypes.includes("application/vnd.myscript.jiix")&&this.recognition.text.mimeTypes.push("application/vnd.myscript.jiix"):this.rendering.smartGuide.enable=!1,__classPrivateFieldGet(this,T,"f").debug("overrideDefaultConfiguration",{configuration:this})}}T=new WeakMap;const D={EDITOR:"4",BEHAVIORS:"4",RECOGNIZER:"4",GRABBER:"4",RENDERER:"4",CONFIGURATION:"4",PUBLIC_EVENT:"4",INTERNAL_EVENT:"4",MODEL:"4",STROKE:"4",SMARTGUIDE:"4",STYLE:"4",UNDO_REDO:"4"},R={NO_ACTIVITY:"Session closed due to no activity.",WRONG_CREDENTIALS:"Application credentials are invalid. Please check or regenerate your application key and hmackey.",TOO_OLD:"Session is too old. Max Session Duration Reached.",UNKNOW:"An unknown error has occurred.",ABNORMAL_CLOSURE:"MyScript recognition server is not reachable.",CANT_ESTABLISH:"Unable to establish a connection to MyScript recognition server. Check the host and your connectivity.",GOING_AWAY:"MyScript recognition server is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.",PROTOCOL_ERROR:"MyScript recognition server terminated the connection due to a protocol error.",UNSUPPORTED_DATA:"MyScript recognition server terminated the connection because the endpoint received data of a type it cannot accept. (For example, a text-only endpoint received binary data.)",INVALID_FRAME_PAULOAD:"MyScript recognition server terminated the connection because a message was received that contained inconsistent data (e.g., non-UTF-8 data within a text message).",POLICY_VIOLATION:"MyScript recognition server terminated the connection because it received a message that violates its policy.",MESSAGE_TOO_BIG:"MyScript recognition server terminated the connection because a data frame was received that is too large.",INTERNAL_ERROR:"MyScript recognition server terminated the connection because it encountered an unexpected condition that prevented it from fulfilling the request.",SERVICE_RESTART:"MyScript recognition server terminated the connection because it is restarting.",TRY_AGAIN:"MyScript recognition server terminated the connection due to a temporary condition, e.g. it is overloaded and is casting off some of its clients.",BAD_GATEWAY:"MyScript recognition server was acting as a gateway or proxy and received an invalid response from the upstream server.",TLS_HANDSHAKE:"MyScript recognition server connection was closed due to a failure to perform a TLS handshake"},A={CHANGED:"changed",CLEARED:"cleared",CONVERTED:"converted",ERROR:"error",POINTEREVENTS:"pointer_events",EXPORTED:"exported",IMPORTED:"imported",IDLE:"idle",LOADED:"loaded"},I={SVG_PATCH:"internal_svg_patch",EXPORTED:"internal_exported",CLEAR_MESSAGE:"internal_clear_message",ERROR:"internal_error",NOTIF:"internal_notif",IMPORT_JIIX:"internal_import_jiix",CONVERT:"internal_convert",CLEAR:"internal_clear",CONTEXT_CHANGE:"internal_context_change",IDLE:"internal_idle",WS_CLOSED:"internal_websocket_closed"};var N,O,z,j,W,U,$,H,B,V,J,X,q,Y,Z,K,Q;i.ExportType=void 0,(N=i.ExportType||(i.ExportType={})).JIIX="application/vnd.myscript.jiix",N.TEXT="text/plain",N.LATEX="application/x-latex",N.MATHML="application/mathml+xml",N.SVG="image/svg+xml",N.OFFICE_DOCUMENT="application/vnd.openxmlformats-officedocument.presentationml.presentation",i.Intention=void 0,(O=i.Intention||(i.Intention={})).Write="write",O.Erase="erase",i.LoggerLevel=void 0,(z=i.LoggerLevel||(i.LoggerLevel={})).DEBUG="1",z.INFO="2",z.WARN="3",z.ERROR="4",i.LoggerClass=void 0,(j=i.LoggerClass||(i.LoggerClass={})).EDITOR="EDITOR",j.RECOGNIZER="RECOGNIZER",j.GRABBER="GRABBER",j.BEHAVIORS="BEHAVIORS",j.CONFIGURATION="CONFIGURATION",j.PUBLIC_EVENT="PUBLIC_EVENT",j.MODEL="MODEL",j.RENDERER="RENDERER",j.SMARTGUIDE="SMARTGUIDE",j.STYLE="STYLE",j.UNDO_REDO="UNDO_REDO",j.STROKE="STROKE",j.INTERNAL_EVENT="INTERNAL_EVENT";class InternalEvent extends EventTarget{constructor(){super(),W.add(this),H.set(this,void 0),B.set(this,LoggerManager.getLogger("INTERNAL_EVENT")),__classPrivateFieldGet(this,B,"f").info("constructor"),__classPrivateFieldSet(this,H,new AbortController,"f")}static getInstance(){return __classPrivateFieldGet(U,U,"f",$)||__classPrivateFieldSet(U,U,new U,"f",$),__classPrivateFieldGet(U,U,"f",$)}removeAllListeners(){__classPrivateFieldGet(this,B,"f").info("removeAllListeners"),__classPrivateFieldGet(this,H,"f").abort(),__classPrivateFieldSet(this,H,new AbortController,"f")}emitSVGPatch(i){__classPrivateFieldGet(this,B,"f").info("emitSVGPatch",{patchChange:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.SVG_PATCH,i)}addSVGPatchListener(i){__classPrivateFieldGet(this,B,"f").info("addSVGPatchListener",{callback:i}),this.addEventListener(I.SVG_PATCH,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitExported(i){__classPrivateFieldGet(this,B,"f").info("emitExported",{exports:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.EXPORTED,i)}addExportedListener(i){__classPrivateFieldGet(this,B,"f").info("addExportedListener",{callback:i}),this.addEventListener(I.EXPORTED,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitClearMessage(){__classPrivateFieldGet(this,B,"f").info("emitClearMessage"),__classPrivateFieldGet(this,W,"m",V).call(this,I.CLEAR_MESSAGE)}addClearMessageListener(i){__classPrivateFieldGet(this,B,"f").info("addClearMessageListener",{callback:i}),this.addEventListener(I.CLEAR_MESSAGE,(()=>i()),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitError(i){__classPrivateFieldGet(this,B,"f").info("emitError",{err:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.ERROR,i)}addErrorListener(i){__classPrivateFieldGet(this,B,"f").info("addErrorListener",{callback:i}),this.addEventListener(I.ERROR,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitWSClosed(){__classPrivateFieldGet(this,B,"f").info("emitWSClosed"),__classPrivateFieldGet(this,W,"m",V).call(this,I.WS_CLOSED)}addWSClosedListener(i){__classPrivateFieldGet(this,B,"f").info("addWSClosedListener",{callback:i}),this.addEventListener(I.WS_CLOSED,(()=>i()),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitNotif(i){__classPrivateFieldGet(this,B,"f").info("emitWNotif",{notif:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.NOTIF,i)}addNotifListener(i){__classPrivateFieldGet(this,B,"f").info("addNotifListener",{callback:i}),this.addEventListener(I.NOTIF,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitImportJIIX(i){__classPrivateFieldGet(this,B,"f").info("emitImportJIIX",{jiix:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.IMPORT_JIIX,i)}addImportJIIXListener(i){__classPrivateFieldGet(this,B,"f").info("addImportJIIXListener",{callback:i}),this.addEventListener(I.IMPORT_JIIX,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitConvert(i="DIGITAL_EDIT"){__classPrivateFieldGet(this,B,"f").info("emitConvert",{conversionState:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.CONVERT,i)}addConvertListener(i){__classPrivateFieldGet(this,B,"f").info("addConvertListener",{callback:i}),this.addEventListener(I.CONVERT,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitClear(){__classPrivateFieldGet(this,B,"f").info("emitClear"),__classPrivateFieldGet(this,W,"m",V).call(this,I.CLEAR)}addClearListener(i){__classPrivateFieldGet(this,B,"f").info("addClearListener",{callback:i}),this.addEventListener(I.CLEAR,(()=>i()),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitContextChange(i){__classPrivateFieldGet(this,B,"f").info("emitContextChange",{context:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.CONTEXT_CHANGE,i)}addContextChangeListener(i){__classPrivateFieldGet(this,B,"f").info("addContextChangeListener",{callback:i}),this.addEventListener(I.CONTEXT_CHANGE,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}emitIdle(i){__classPrivateFieldGet(this,B,"f").info("emitIdle",{idle:i}),__classPrivateFieldGet(this,W,"m",V).call(this,I.IDLE,i)}addIdleListener(i){__classPrivateFieldGet(this,B,"f").info("addIdleListener",{callback:i}),this.addEventListener(I.IDLE,(s=>i(s.detail)),{signal:__classPrivateFieldGet(this,H,"f").signal})}}U=InternalEvent,H=new WeakMap,B=new WeakMap,W=new WeakSet,V=function _InternalEvent_emit(i,s){this.dispatchEvent(new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},s?{detail:s}:void 0)))},$={value:void 0};class PublicEvent extends EventTarget{constructor(){super(),J.add(this),Y.set(this,void 0),Z.set(this,LoggerManager.getLogger("PUBLIC_EVENT"))}static getInstance(){return __classPrivateFieldGet(X,X,"f",q)||__classPrivateFieldSet(X,X,new X,"f",q),__classPrivateFieldGet(X,X,"f",q)}setElement(i){__classPrivateFieldGet(this,Z,"f").info("setElement",{el:i}),__classPrivateFieldSet(this,Y,i,"f")}emitLoaded(){__classPrivateFieldGet(this,Z,"f").info("emitLoaded"),__classPrivateFieldGet(this,J,"m",K).call(this,A.LOADED)}emitExported(i){__classPrivateFieldGet(this,Z,"f").info("emitExported",{exports:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.EXPORTED,i)}emitChanged(i){__classPrivateFieldGet(this,Z,"f").info("emitChanged",{undoRedoContext:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.CHANGED,Object.assign(Object.assign({},i),{canClear:!i.empty}))}emitIdle(i){__classPrivateFieldGet(this,Z,"f").info("emitIdle",{idle:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.IDLE,i)}emitCleared(i){__classPrivateFieldGet(this,Z,"f").info("emitCleared",{model:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.CLEARED,i)}emitConverted(i){__classPrivateFieldGet(this,Z,"f").info("emitConverted",{exports:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.CONVERTED,i)}emitImported(i){__classPrivateFieldGet(this,Z,"f").info("emitImported",{exports:i}),__classPrivateFieldGet(this,J,"m",K).call(this,A.IMPORTED,i)}}X=PublicEvent,Y=new WeakMap,Z=new WeakMap,J=new WeakSet,K=function _PublicEvent_emit(i,s){var r;const n=new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},s?{detail:s}:void 0));this.dispatchEvent(n),null===(r=__classPrivateFieldGet(this,Y,"f"))||void 0===r||r.dispatchEvent(n)},q={value:void 0};class PointerEventGrabber{constructor(i){this.prevent=i=>i.preventDefault(),Q.set(this,LoggerManager.getLogger("GRABBER")),this.pointerDownHandler=i=>{if(__classPrivateFieldGet(this,Q,"f").info("pointerDown",{evt:i}),0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const s=this.extractPoint(i);this.onPointerDown(i,s)}},this.pointerMoveHandler=i=>{if(__classPrivateFieldGet(this,Q,"f").info("pointerMove",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId){if(i.target.classList.contains("smartguide"))return void this.pointerUpHandler(i);if(this.onPointerMove){const s=this.extractPoint(i);this.onPointerMove(i,s)}}},this.pointerUpHandler=i=>{if(__classPrivateFieldGet(this,Q,"f").info("pointerUp",{evt:i}),null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},this.pointerOutHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&!this.domElement.contains(i.target)&&(i.stopPropagation(),this.activePointerId=void 0,this.onPointerUp)){const s=this.extractPoint(i);this.onPointerUp(i,s)}},__classPrivateFieldGet(this,Q,"f").info("constructor",{configuration:i}),this.configuration=i}roundFloat(i,s){if(s>=0){const r=Math.pow(10,s);return Math.round(i/r)*r}return __classPrivateFieldGet(this,Q,"f").debug("roundFloat",{oneFloat:i,requestedFloatPrecision:s}),i}extractPoint(i){let s,r;({clientX:s,clientY:r}="changedTouches"in i?i.changedTouches[0]:i);const n=this.domElement.getBoundingClientRect(),a={x:this.roundFloat(s-n.left-this.domElement.clientLeft+this.domElement.scrollLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(r-n.top-this.domElement.clientTop+this.domElement.scrollTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure||1};return __classPrivateFieldGet(this,Q,"f").debug("extractPoint",{event:i,pointer:a}),a}attach(i){__classPrivateFieldGet(this,Q,"f").info("attach",{domElement:i}),this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),this.domElement.addEventListener("touchmove",this.prevent),document.documentElement.addEventListener("pointerdown",(()=>{}))}detach(){var i,s,r,n,a,l,d;__classPrivateFieldGet(this,Q,"f").info("detach"),null===(i=this.domElement)||void 0===i||i.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),null===(s=this.domElement)||void 0===s||s.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),null===(r=this.domElement)||void 0===r||r.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),null===(n=this.domElement)||void 0===n||n.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),null===(a=this.domElement)||void 0===a||a.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),null===(l=this.domElement)||void 0===l||l.removeEventListener("pointerout",this.pointerOutHandler,this.configuration.listenerOptions),null===(d=this.domElement)||void 0===d||d.removeEventListener("touchmove",this.prevent),document.documentElement.removeEventListener("pointerdown",(()=>{}))}}Q=new WeakMap;const ee={},te={ink:{color:"#000000",width:1,"-myscript-pen-width":1,"-myscript-pen-fill-style":"none","-myscript-pen-fill-color":"#FFFFFF00"},".math":{"font-family":"STIXGeneral"},".math-solved":{"font-family":"STIXGeneral",color:"#A8A8A8FF"},".text":{"font-family":"MyScriptInter","font-size":10}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var ie=function createCommonjsModule(i,s){return i(s={exports:{}},s.exports),s.exports}((function(i,s){i.exports=function(i){function e(r){if(s[r])return s[r].exports;var n=s[r]={i:r,l:!1,exports:{}};return i[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var s={};return e.m=i,e.c=s,e.i=function(i){return i},e.d=function(i,s,r){e.o(i,s)||Object.defineProperty(i,s,{configurable:!1,enumerable:!0,get:r})},e.n=function(i){var s=i&&i.__esModule?function(){return i.default}:function(){return i};return e.d(s,"a",s),s},e.o=function(i,s){return Object.prototype.hasOwnProperty.call(i,s)},e.p="",e(e.s=1)}([function(i,s,r){function o(i,s){if(!(i instanceof s))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(s,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},a=function t(i){var s=this;o(this,t),this.toJSON=function(i){if("string"!=typeof i)return console.error("Need a CSS string but given ",void 0===i?"undefined":n(i),i),"Not a valid CSS..!";var r={},a=void 0,l=void 0,d=void 0;try{i.split("{").forEach((function(i){if(l=i.trim())if(-1===l.indexOf("}"))r[l]={},a=l;else{l.substring(0,l.indexOf("}")).split(";").forEach((function(i){(d=i.split(":"))&&2===d.length&&(r[a][d[0].trim().replace(/^\"|\"$/g,"")]=s._trimSemiColon(d[1].trim().replace(/^\"|\"$/g,"")))}));try{(a=l.split("}")[1].trim())&&(r[a]={})}catch(i){}}}))}catch(i){return"Not a valid CSS..!"}return r},this.toCSS=function(i){if("object"!==(void 0===i?"undefined":n(i)))return console.error("Need a JSON object but given ",void 0===i?"undefined":n(i),i),"Not a valid JSON..!";var s="";try{for(var r in i)if(i.hasOwnProperty(r)){for(var a in s+=r+" {\n",i[r])i[r].hasOwnProperty(a)&&(s+=a+": "+i[r][a]+";\n");s+="}\n"}}catch(i){return"Not a valid JSON..!"}return s},this._trimSemiColon=function(i){return";"===i.slice(-1)?i.slice(0,s.length-1):i}};s.default=a},function(i,s,r){i.exports=r(0).default}])})),se=function unwrapExports(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}(ie);ie.JsonCSS;const re=new se,ne={themeToCSS:i=>re.toCSS(i),themeToJSON(i){const s=re.toJSON(i);return s[".text"]["font-size"]=Number(s[".text"]["font-size"]),s.ink["-myscript-pen-width"]=Number(s.ink["-myscript-pen-width"]),s.ink.width=Number(s.ink.width),s},penStyleToCSS(i){let s=re.toCSS({css:i});return s=s.substring(6,s.length-3),s},penStyleToJSON(i){const s=re.toJSON(`css {${i}}`).css;return s.width?s.width=Number(s.width):delete s.width,s["-myscript-pen-width"]?s["-myscript-pen-width"]=Number(s["-myscript-pen-width"]):delete s["-myscript-pen-width"],s},stringToJSON:i=>re.toJSON(`css {${i}}`).css,JSONToString:i=>Object.entries(i).map((([i,s])=>`${i}:${s}`)).join(";")};var oe,ae,le,de,ce,he,pe,ve,ue,fe,ge,me,_e,Pe,ye,xe,we,be,Se,Fe,Ge,Ee,Ce,ke,Me,Te,Le,De,Re,Ae,Ie,Ne,Oe,ze,je,We,Ue,$e,He,Be,Ve,Je,Xe,qe,Ye,Ze,Ke,Qe,et,tt,it,st,rt,nt,ot,at,lt,dt,ct,ht,pt,vt,ut,ft,gt,mt,_t,Pt,yt,xt,wt,bt,St,Ft,Gt,Et,Ct,kt,Mt,Tt,Lt,Dt,Rt,At;class StyleManager{constructor(i,s){oe.set(this,void 0),ae.set(this,void 0),le.set(this,void 0),de.set(this,void 0),ce.set(this,LoggerManager.getLogger("STYLE")),__classPrivateFieldGet(this,ce,"f").info("constructor",{penStyle:i,theme:s}),this.setTheme(s),this.setPenStyleClasses(),this.setPenStyle(i)}get currentPenStyle(){return __classPrivateFieldGet(this,de,"f")||__classPrivateFieldGet(this,oe,"f")}get penStyle(){return __classPrivateFieldGet(this,oe,"f")}setPenStyle(i){__classPrivateFieldGet(this,ce,"f").info("setPenStyle",{style:i}),__classPrivateFieldSet(this,oe,mergeDeep(structuredClone(ee),i||{}),"f"),__classPrivateFieldSet(this,de,i||this.theme[`.${__classPrivateFieldGet(this,le,"f")}`],"f"),__classPrivateFieldGet(this,ce,"f").debug("setPenStyle",__classPrivateFieldGet(this,de,"f"))}get theme(){return __classPrivateFieldGet(this,ae,"f")}setTheme(i){__classPrivateFieldGet(this,ce,"f").info("setTheme",{theme:i}),__classPrivateFieldSet(this,ae,mergeDeep(structuredClone(te),i||{}),"f"),__classPrivateFieldGet(this,ce,"f").debug("setTheme",__classPrivateFieldGet(this,ae,"f"))}get penStyleClasses(){return __classPrivateFieldGet(this,le,"f")}setPenStyleClasses(i=""){__classPrivateFieldGet(this,ce,"f").info("setPenStyleClasses",{penStyleClass:i}),__classPrivateFieldSet(this,le,i,"f"),__classPrivateFieldSet(this,de,this.theme[`.${__classPrivateFieldGet(this,le,"f")}`],"f"),__classPrivateFieldGet(this,ce,"f").debug("setPenStyleClasses",__classPrivateFieldGet(this,de,"f"))}}oe=new WeakMap,ae=new WeakMap,le=new WeakMap,de=new WeakMap,ce=new WeakMap,i.SymbolType=void 0,(he=i.SymbolType||(i.SymbolType={})).Stroke="stroke",he.Shape="shape",he.Text="text";class AbstractSymbol{constructor(i,s){this.creationTime=Date.now(),this.id=`${i}-${createUUID()}`,this.modificationDate=this.creationTime,this.type=i,this.style=s}}class Stroke extends AbstractSymbol{constructor(i,s,r="pen"){super("stroke",i),pe.set(this,LoggerManager.getLogger("STROKE")),__classPrivateFieldGet(this,pe,"f").info("constructor",{style:i,pointerId:s,pointerType:r}),this.style=i,this.pointerId=s,this.pointerType=r,this.pointers=[],this.length=0}getClone(){const i=new Stroke(this.style,this.pointerId,this.pointerType);return i.id=this.id,i.creationTime=this.creationTime,i.modificationDate=this.modificationDate,i.pointers=structuredClone(this.pointers),i.length=this.length,i}formatToSend(){const i={id:this.id,pointerType:this.pointerType,p:[],t:[],x:[],y:[]};return this.pointers.forEach((s=>{i.p.push(s.p),i.t.push(s.t),i.x.push(s.x),i.y.push(s.y)})),i}}pe=new WeakMap;class Model{constructor(i=100,s=100,r=0,n=Date.now()){ve.set(this,LoggerManager.getLogger("MODEL")),__classPrivateFieldGet(this,ve,"f").info("constructor",{width:i,height:s,creationDate:n}),this.creationTime=n,this.modificationDate=n,this.width=i,this.height=s,this.rowHeight=r,this.symbols=[],this.positions={lastSentPosition:0,lastReceivedPosition:0},this.idle=!0}computePressure(i,s){let r=1;i===s?r=1:i<10?r=.2+Math.pow(.1*i,.4):i>s-10&&(r=.2+Math.pow(.1*(s-i),.4));const n=r*Math.max(.1,1-.1*Math.sqrt(i));return isNaN(n)?.5:Math.round(100*n)/100}filterPointByAcquisitionDelta(i,s,r){const n=2+(i.style["-myscript-pen-width"]||0)/4;return!r||0===i.pointers.length||Math.abs(r.x-s.x)>=n||Math.abs(r.y-s.y)>=n}getStrokeFromPoint(i){__classPrivateFieldGet(this,ve,"f").info("getStrokeFromPoint",{point:i});const isBetween=(i,s,r)=>i>=s&&i<=r,s=[];return this.symbols.forEach((r=>{for(let n=0;n<r.pointers.length;n++){const a=r.pointers[n];if(isBetween(a.x,i.x-5,i.x+5)&&isBetween(a.y,i.y-5,i.y+5)){s.push(r);break}if(computeDistance(i,a)<10){s.push(r);break}}})),__classPrivateFieldGet(this,ve,"f").debug("getStrokeFromPoint",{strokes:s}),s}addPoint(i,s){__classPrivateFieldGet(this,ve,"f").debug("addPoint",{stroke:i,pointer:s});const r=i.pointers.at(-1);if(this.filterPointByAcquisitionDelta(i,s,r)){const n=r?computeDistance(s,r):0;i.length+=n,s.p=this.computePressure(n,i.length),i.pointers.push(s),i.modificationDate=Date.now()}}addStroke(i){__classPrivateFieldGet(this,ve,"f").info("addStroke",{stroke:i}),this.symbols.push(i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0}updateStroke(i){__classPrivateFieldGet(this,ve,"f").info("updateStroke",{updatedStroke:i});const s=this.symbols.findIndex((s=>s.id===i.id));-1!==s&&(i.modificationDate=Date.now(),this.symbols.splice(s,1,i),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,ve,"f").debug("updateStroke",this.symbols)}removeStroke(i){__classPrivateFieldGet(this,ve,"f").info("removeStroke",{id:i});const s=this.symbols.findIndex((s=>s.id===i));-1!==s&&(this.positions.lastSentPosition--,this.positions.lastReceivedPosition--,this.symbols.splice(s,1),this.modificationDate=Date.now(),this.converts=void 0,this.exports=void 0),__classPrivateFieldGet(this,ve,"f").debug("removeStroke",this.symbols)}removeStrokesFromPoint(i){__classPrivateFieldGet(this,ve,"f").info("removeStrokesFromPoint",{point:i});const s=this.getStrokeFromPoint(i);return s.forEach((i=>{this.removeStroke(i.id)})),__classPrivateFieldGet(this,ve,"f").debug("removeStrokesFromPoint",s.map((i=>i.id))),s.map((i=>i.id))}extractUnsentStrokes(){return this.symbols.slice(this.positions.lastSentPosition)}initCurrentStroke(i,s,r,n,a=96){if(__classPrivateFieldGet(this,ve,"f").info("initCurrentStroke",{point:i,pointerId:s,pointerType:r,style:n,dpi:a}),n["-myscript-pen-width"]){const i=n["-myscript-pen-width"]*a/25.4;n.width=i/2}this.modificationDate=Date.now(),this.exports=void 0,this.currentSymbol=new Stroke(n,s,r),__classPrivateFieldGet(this,ve,"f").debug("initCurrentStroke",this.currentSymbol),this.addPoint(this.currentSymbol,i)}appendToCurrentStroke(i){__classPrivateFieldGet(this,ve,"f").info("appendToCurrentStroke",{point:i}),this.currentSymbol&&this.addPoint(this.currentSymbol,i),__classPrivateFieldGet(this,ve,"f").debug("appendToCurrentStroke",this.currentSymbol)}endCurrentStroke(i){__classPrivateFieldGet(this,ve,"f").info("endCurrentStroke",{point:i}),this.currentSymbol&&(this.addPoint(this.currentSymbol,i),this.addStroke(this.currentSymbol),this.currentSymbol=void 0),__classPrivateFieldGet(this,ve,"f").debug("endCurrentStroke",this.currentSymbol)}updatePositionSent(i=this.symbols.length){__classPrivateFieldGet(this,ve,"f").info("updatePositionSent",{position:i}),this.positions.lastSentPosition=i,__classPrivateFieldGet(this,ve,"f").debug("updatePositionSent",this.positions.lastSentPosition)}updatePositionReceived(){__classPrivateFieldGet(this,ve,"f").info("updatePositionReceived"),this.positions.lastReceivedPosition=this.positions.lastSentPosition,__classPrivateFieldGet(this,ve,"f").debug("updatePositionReceived",this.positions.lastReceivedPosition)}mergeExport(i){__classPrivateFieldGet(this,ve,"f").info("mergeExport",{exports:i}),this.exports?Object.assign(this.exports,i):this.exports=i,__classPrivateFieldGet(this,ve,"f").debug("mergeExport",this.exports)}mergeConvert(i){__classPrivateFieldGet(this,ve,"f").info("mergeConvert",{converts:i}),this.converts?Object.assign(this.converts,i):this.converts=i,__classPrivateFieldGet(this,ve,"f").debug("mergeConvert",this.converts)}getClone(){__classPrivateFieldGet(this,ve,"f").info("getClone");const i=new Model(this.width,this.height,this.rowHeight,this.creationTime);return i.modificationDate=JSON.parse(JSON.stringify(this.modificationDate)),i.currentSymbol=this.currentSymbol?this.currentSymbol.getClone():void 0,i.symbols=this.symbols.map((i=>i.getClone())),i.positions=JSON.parse(JSON.stringify(this.positions)),i.exports=this.exports?JSON.parse(JSON.stringify(this.exports)):void 0,i.converts=this.converts?JSON.parse(JSON.stringify(this.converts)):void 0,i.idle=this.idle,__classPrivateFieldGet(this,ve,"f").debug("getClone",{clonedModel:i}),i}clear(){__classPrivateFieldGet(this,ve,"f").info("clear"),this.modificationDate=Date.now(),this.currentSymbol=void 0,this.symbols=[],this.positions.lastSentPosition=0,this.positions.lastReceivedPosition=0,this.exports=void 0,this.converts=void 0,this.idle=!0}}ve=new WeakMap;class RestRecognizer{constructor(i,s){ue.set(this,LoggerManager.getLogger("RECOGNIZER")),__classPrivateFieldGet(this,ue,"f").info("constructor",{serverConfig:i,recognitionConfig:s}),this.serverConfiguration=i,this.recognitionConfiguration=s}get url(){return`${this.serverConfiguration.scheme}://${this.serverConfiguration.host}/api/v4.0/iink/batch`}get postConfig(){switch(this.recognitionConfiguration.type){case"DIAGRAM":return{lang:this.recognitionConfiguration.lang,diagram:this.recognitionConfiguration.diagram,export:this.recognitionConfiguration.export};case"MATH":return{lang:this.recognitionConfiguration.lang,math:this.recognitionConfiguration.math,export:this.recognitionConfiguration.export};case"Raw Content":return{lang:this.recognitionConfiguration.lang,"raw-content":this.recognitionConfiguration["raw-content"],export:this.recognitionConfiguration.export};case"TEXT":return{lang:this.recognitionConfiguration.lang,text:this.recognitionConfiguration.text,export:this.recognitionConfiguration.export};default:throw new Error(`get postConfig error Recognition type unkow "${this.recognitionConfiguration.type}"`)}}buildData(i){__classPrivateFieldGet(this,ue,"f").info("buildData",{model:i});const s=[];i.symbols.forEach((i=>{const r=s.findIndex((s=>{return r=s.penStyle,n=i.style,r&&n&&r["-myscript-pen-fill-color"]===n["-myscript-pen-fill-color"]&&r["-myscript-pen-fill-style"]===n["-myscript-pen-fill-style"]&&r["-myscript-pen-width"]===n["-myscript-pen-width"]&&r.color===n.color&&r.width===n.width;var r,n}));r>-1?s[r].strokes.push(i):s.push({penStyle:i.style,strokes:[i]})}));const r=[];s.forEach((i=>{const s={penStyle:"{}"===JSON.stringify(i.penStyle)?void 0:ne.penStyleToCSS(i.penStyle),strokes:i.strokes.map((i=>i.formatToSend()))};r.push(s)}));const n="Raw Content"===this.recognitionConfiguration.type?"Raw Content":this.recognitionConfiguration.type.charAt(0).toUpperCase()+this.recognitionConfiguration.type.slice(1).toLowerCase(),a={configuration:this.postConfig,xDPI:96,yDPI:96,contentType:n,height:i.height,width:i.width,strokeGroups:r};return __classPrivateFieldGet(this,ue,"f").debug("buildData",{data:a}),a}post(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ue,"f").info("post",{data:i,mimeType:s});const r=new Headers;r.append("Accept","application/json,"+s),r.append("applicationKey",this.serverConfiguration.applicationKey);try{const s=yield computeHmac(JSON.stringify(i),this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey);r.append("hmac",s)}catch(i){__classPrivateFieldGet(this,ue,"f").error("post.computeHmac",i)}r.append("Content-Type","application/json"),isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(r.append("myscript-client-name","iink-ts"),r.append("myscript-client-version","1.0.5"));const n={method:"POST",headers:r,body:JSON.stringify(i)},a=new Request(this.url,n),l=yield fetch(a);if(l.ok){let i;switch(l.headers.get("content-type")){case"application/vnd.openxmlformats-officedocument.presentationml.presentation":case"image/png":case"image/jpeg":i=yield l.blob();break;case"application/json":i=yield l.json();break;case"application/vnd.myscript.jiix":i=yield l.clone().json().catch((()=>__awaiter(this,void 0,void 0,(function*(){return yield l.text()}))));break;default:i=yield l.text()}return __classPrivateFieldGet(this,ue,"f").debug("post",{result:i}),i}{const i=yield l.json();throw __classPrivateFieldGet(this,ue,"f").error("post",{err:i}),i}}))}tryFetch(i,s){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,ue,"f").debug("tryFetch",{data:i,mimeType:s}),this.post(i,s).then((i=>{const r={};return r[s]=i,__classPrivateFieldGet(this,ue,"f").debug("tryFetch",{exports:r}),r})).catch((r=>{__classPrivateFieldGet(this,ue,"f").error("tryFetch",{data:i,mimeType:s,err:r});let n=r.message||R.UNKNOW;r.code?"access.not.granted"===r.code&&(n=R.WRONG_CREDENTIALS):n=R.CANT_ESTABLISH;throw new Error(n)}))}))}getMimeTypes(i){__classPrivateFieldGet(this,ue,"f").info("getMimeTypes",{requestedMimeTypes:i});let s=i||[];if(!s.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":s=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":s=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":s=["application/vnd.myscript.jiix"];break;case"TEXT":s=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}return s}convert(i,s,r){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ue,"f").info("convert",{model:i,conversionState:s,requestedMimeTypes:r});const n=i.getClone(),a=this.getMimeTypes(r),l=this.buildData(n);l.conversionState=s;const d=a.map((i=>this.tryFetch(l,i)));return(yield Promise.all(d)).forEach((i=>{n.mergeConvert(i)})),__classPrivateFieldGet(this,ue,"f").debug("convert",{model:n}),n}))}export(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,ue,"f").info("export",{model:i,requestedMimeTypes:s});const r=i.getClone();if(0===r.symbols.length)return Promise.resolve(r);const n=this.getMimeTypes(s);if(!n.length)return __classPrivateFieldGet(this,ue,"f").error("export",{model:i,requestedMimeTypes:s,"Export failed, no mimeTypes define in recognition configuration":String}),Promise.reject(new Error("Export failed, no mimeTypes define in recognition configuration"));const a=n.filter((i=>!r.exports||!r.exports[i])),l=this.buildData(i);return(yield Promise.all(a.map((i=>this.tryFetch(l,i))))).forEach((i=>{r.mergeExport(i)})),__classPrivateFieldGet(this,ue,"f").debug("export",{model:r}),r}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,ue,"f").info("resize",{model:i}),this.export(i)}))}}ue=new WeakMap;class WSRecognizer{constructor(i,s){fe.set(this,LoggerManager.getLogger("RECOGNIZER")),this.pingCount=0,this.reconnectionCount=0,this.serverConfiguration=i,this.recognitionConfiguration=s;const r="https"===this.serverConfiguration.scheme?"wss":"ws";this.url=`${r}://${this.serverConfiguration.host}/api/v4.0/iink/document?applicationKey=${this.serverConfiguration.applicationKey}`,__classPrivateFieldGet(this,fe,"f").info("constructor",{serverConfig:i,recognitionConfig:s,url:this.url})}get mimeTypes(){switch(this.recognitionConfiguration.type.toLocaleLowerCase()){case"text":return this.recognitionConfiguration.text.mimeTypes;case"math":return this.recognitionConfiguration.math.mimeTypes;default:throw new Error(`Unauthorized recognition type: "${this.recognitionConfiguration.type}"`)}}get internalEvent(){return InternalEvent.getInstance()}infinitePing(){this.pingCount++,this.serverConfiguration.websocket.maxPingLostCount<this.pingCount?this.socket.close(1e3,"PING_LOST"):this.socket.readyState<=1&&setTimeout((()=>{this.socket.readyState<=1&&(this.socket.send(JSON.stringify({type:"ping"})),this.infinitePing())}),this.serverConfiguration.websocket.pingDelay)}openCallback(){var i;null===(i=this.connected)||void 0===i||i.resolve();const s={type:this.sessionId?"restoreIInkSession":"newContentPackage",iinkSessionId:this.sessionId,applicationKey:this.serverConfiguration.applicationKey,xDpi:96,yDpi:96,viewSizeHeight:this.viewSizeHeight,viewSizeWidth:this.viewSizeWidth};isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.0.4")&&(s["myscript-client-name"]="iink-ts",s["myscript-client-version"]="1.0.5"),this.send(s)}rejectDeferredPending(i){var s,r,n,a,l,d,c,h,p,v,u,f,g,m,_,P,y,x,w,b;(null===(s=this.connected)||void 0===s?void 0:s.isPending)&&(null===(r=this.connected)||void 0===r||r.reject(i)),(null===(n=this.initialized)||void 0===n?void 0:n.isPending)&&(null===(a=this.initialized)||void 0===a||a.reject(i)),(null===(l=this.addStrokeDeferred)||void 0===l?void 0:l.isPending)&&(null===(d=this.addStrokeDeferred)||void 0===d||d.reject(i)),(null===(c=this.exportDeferred)||void 0===c?void 0:c.isPending)&&(null===(h=this.exportDeferred)||void 0===h||h.reject(i)),(null===(p=this.convertDeferred)||void 0===p?void 0:p.isPending)&&(null===(v=this.convertDeferred)||void 0===v||v.reject(i)),(null===(u=this.importDeferred)||void 0===u?void 0:u.isPending)&&(null===(f=this.importDeferred)||void 0===f||f.reject(i)),(null===(g=this.resizeDeferred)||void 0===g?void 0:g.isPending)&&(null===(m=this.resizeDeferred)||void 0===m||m.reject(i)),(null===(_=this.undoDeferred)||void 0===_?void 0:_.isPending)&&(null===(P=this.undoDeferred)||void 0===P||P.reject(i)),(null===(y=this.redoDeferred)||void 0===y?void 0:y.isPending)&&(null===(x=this.redoDeferred)||void 0===x||x.reject(i)),(null===(w=this.clearDeferred)||void 0===w?void 0:w.isPending)&&this.clearDeferred.reject(i),(null===(b=this.waitForIdleDeferred)||void 0===b?void 0:b.isPending)&&this.waitForIdleDeferred.reject(i)}closeCallback(i){let s="";if(!this.currentErrorCode)switch(i.code){case 1e3:break;case 1001:s=R.GOING_AWAY;break;case 1002:s=R.PROTOCOL_ERROR;break;case 1003:s=R.UNSUPPORTED_DATA;break;case 1006:s=R.ABNORMAL_CLOSURE;break;case 1007:s=R.INVALID_FRAME_PAULOAD;break;case 1008:s=R.POLICY_VIOLATION;break;case 1009:s=R.MESSAGE_TOO_BIG;break;case 1011:s=R.INTERNAL_ERROR;break;case 1012:s=R.SERVICE_RESTART;break;case 1013:s=R.TRY_AGAIN;break;case 1014:s=R.BAD_GATEWAY;break;case 1015:s=R.TLS_HANDSHAKE;break;default:__classPrivateFieldGet(this,fe,"f").warn("closeCallback","unknow CloseEvent.code",{evt:i}),s=R.CANT_ESTABLISH}const r=new Error(s||i.reason);this.rejectDeferredPending(r),this.currentErrorCode||1e3===i.code||this.internalEvent.emitError(r)}manageAckMessage(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("manageAckMessage",{websocketMessage:i});const r=i;r.hmacChallenge&&this.send({type:"hmac",hmac:yield computeHmac(r.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)}),r.iinkSessionId&&(this.sessionId=r.iinkSessionId);const n=structuredClone(this.recognitionConfiguration);isVersionSuperiorOrEqual(this.serverConfiguration.version,"2.3.0")||delete n.convert,this.send(Object.assign(Object.assign({},n),{type:"configuration"})),null===(s=this.ackDeferred)||void 0===s||s.resolve()}))}manageContentPackageDescriptionMessage(){var i;return __awaiter(this,void 0,void 0,(function*(){this.reconnectionCount=0,yield null===(i=this.ackDeferred)||void 0===i?void 0:i.promise,__classPrivateFieldGet(this,fe,"f").info("manageContentPackageDescriptionMessage"),this.currentPartId?this.send({type:"openContentPart",id:this.currentPartId,mimeTypes:this.mimeTypes}):this.send({type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}))}managePartChangeMessage(i){var s;__classPrivateFieldGet(this,fe,"f").info("managePartChangeMessage",{websocketMessage:i});const r=i;this.currentPartId=r.partId,null===(s=this.initialized)||void 0===s||s.resolve()}manageExportMessage(i){var s,r,n,a,l,d,c,h,p;__classPrivateFieldGet(this,fe,"f").info("manageExportMessage",{websocketMessage:i});const v=i;v.exports["application/vnd.myscript.jiix"]&&(v.exports["application/vnd.myscript.jiix"]=JSON.parse(v.exports["application/vnd.myscript.jiix"].toString())),null===(s=this.initialized)||void 0===s||s.resolve(),null===(r=this.addStrokeDeferred)||void 0===r||r.resolve(v.exports),null===(n=this.exportDeferred)||void 0===n||n.resolve(v.exports),null===(a=this.convertDeferred)||void 0===a||a.resolve(v.exports),null===(l=this.importDeferred)||void 0===l||l.resolve(v.exports),null===(d=this.undoDeferred)||void 0===d||d.resolve(v.exports),null===(c=this.redoDeferred)||void 0===c||c.resolve(v.exports),null===(h=this.clearDeferred)||void 0===h||h.resolve(v.exports),null===(p=this.importPointEventsDeferred)||void 0===p||p.resolve(v.exports),this.internalEvent.emitExported(v.exports)}manageWaitForIdle(){var i;return __awaiter(this,void 0,void 0,(function*(){this.internalEvent.emitIdle(!0),null===(i=this.waitForIdleDeferred)||void 0===i||i.resolve()}))}manageErrorMessage(i){var s,r;const n=i;this.currentErrorCode=(null===(s=n.data)||void 0===s?void 0:s.code)||n.code;let a=(null===(r=n.data)||void 0===r?void 0:r.message)||n.message||R.UNKNOW;switch(this.currentErrorCode){case"no.activity":a=R.NO_ACTIVITY;break;case"access.not.granted":a=R.WRONG_CREDENTIALS;break;case"session.too.old":a=R.TOO_OLD}const l=new Error(a);this.rejectDeferredPending(l),this.internalEvent.emitError(l)}manageContentChangeMessage(i){__classPrivateFieldGet(this,fe,"f").info("manageContentChangeMessage",{websocketMessage:i});const s=i,r={canRedo:s.canRedo,canUndo:s.canUndo,empty:s.empty,stackIndex:s.undoStackIndex,possibleUndoCount:s.possibleUndoCount,stack:[]};this.internalEvent.emitContextChange(r)}manageSVGPatchMessage(i){var s;__classPrivateFieldGet(this,fe,"f").info("manageSVGPatchMessage",{websocketMessage:i}),null===(s=this.resizeDeferred)||void 0===s||s.resolve();const r=i;this.internalEvent.emitSVGPatch(r)}messageCallback(i){var s;__classPrivateFieldGet(this,fe,"f").debug("messageCallback",{message:i}),this.currentErrorCode=void 0;const r=JSON.parse(i.data);if("pong"!==r.type)switch(this.pingCount=0,r.type){case"ack":this.manageAckMessage(r);break;case"contentPackageDescription":this.manageContentPackageDescriptionMessage();break;case"partChanged":this.managePartChangeMessage(r);break;case"newPart":null===(s=this.initialized)||void 0===s||s.resolve();break;case"contentChanged":this.manageContentChangeMessage(r);break;case"exported":this.manageExportMessage(r);break;case"svgPatch":this.manageSVGPatchMessage(r);break;case"error":this.manageErrorMessage(r);break;case"idle":this.manageWaitForIdle();break;default:__classPrivateFieldGet(this,fe,"f").warn("messageCallback",`Message type unknow: "${r.type}".`)}}init(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){try{return __classPrivateFieldGet(this,fe,"f").info("init",{height:i,width:s}),this.destroy(),this.connected=new DeferredPromise,this.initialized=new DeferredPromise,this.ackDeferred=new DeferredPromise,this.viewSizeHeight=i,this.viewSizeWidth=s,this.pingCount=0,this.socket=new WebSocket(this.url),this.serverConfiguration.websocket.pingEnabled&&this.infinitePing(),this.socket.addEventListener("open",this.openCallback.bind(this)),this.socket.addEventListener("close",this.closeCallback.bind(this)),this.socket.addEventListener("message",this.messageCallback.bind(this)),this.initialized.promise}catch(i){const s=new Error(R.CANT_ESTABLISH);return this.internalEvent.emitError(s),null===(r=this.initialized)||void 0===r||r.reject(s),null===(n=this.initialized)||void 0===n?void 0:n.promise}}))}send(i){return __awaiter(this,void 0,void 0,(function*(){return this.connected?(yield this.connected.promise,this.socket.readyState===this.socket.OPEN?(__classPrivateFieldGet(this,fe,"f").debug("send",{message:i}),this.socket.send(JSON.stringify(i)),Promise.resolve()):this.socket.readyState!=this.socket.CONNECTING&&this.serverConfiguration.websocket.autoReconnect?(this.reconnectionCount++,this.serverConfiguration.websocket.maxRetryCount>=this.reconnectionCount?(__classPrivateFieldGet(this,fe,"f").debug("send",`try to reconnect number: ${this.reconnectionCount}.`),this.internalEvent.emitClearMessage(),yield this.init(this.viewSizeHeight,this.viewSizeWidth),yield this.setPenStyle(this.penStyle),yield this.setPenStyleClasses(this.penStyleClasses),yield this.setTheme(this.theme),this.send(i)):Promise.reject(new Error("Unable to send message. The maximum number of connection attempts has been reached."))):void 0):Promise.reject(new Error("Recognizer must be initilized"))}))}addStrokes(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,fe,"f").info("addStrokes",{strokes:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.addStrokeDeferred=new DeferredPromise,0===i.length?this.addStrokeDeferred.resolve({}):yield this.send({type:"addStrokes",strokes:i.map((i=>i.formatToSend()))}),null===(r=this.addStrokeDeferred)||void 0===r?void 0:r.promise}))}setPenStyle(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("setPenStyle",{penStyle:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.penStyle=i;const r={type:"setPenStyle",style:ne.penStyleToCSS(i)};return this.send(r)}))}setPenStyleClasses(i){var s;return __awaiter(this,void 0,void 0,(function*(){yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.penStyleClasses=i,__classPrivateFieldGet(this,fe,"f").info("setPenStyleClasses",{penStyleClasses:i});const r={type:"setPenStyleClasses",styleClasses:i};return this.send(r)}))}setTheme(i){var s;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("setTheme",{theme:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.theme=i;const r={type:"setTheme",theme:ne.themeToCSS(i)};return this.send(r)}))}export(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("export",{model:i,requestedMimeTypes:s}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.exportDeferred=new DeferredPromise;const a=i.getClone();let l=s||[];if(!l.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":l=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":l=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":l=["application/vnd.myscript.jiix"];break;case"TEXT":l=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}if(!l.length)return Promise.reject(new Error(`Export failed, no mimeTypes define in recognition ${this.recognitionConfiguration.type} configuration`));const d={type:"export",partId:this.currentPartId,mimeTypes:l};yield this.send(d);const c=yield null===(n=this.exportDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeExport(c),__classPrivateFieldGet(this,fe,"f").debug("export",{model:a}),a}))}import(i,s,r){var n,a;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("import",{data:s,mimeType:r}),yield null===(n=this.initialized)||void 0===n?void 0:n.promise;const l=i.getClone(),d=this.serverConfiguration.websocket.fileChunkSize,c=Math.random().toString(10).substring(2,6);this.importDeferred=new DeferredPromise;const readBlob=i=>{const s=new FileReader;return new Promise(((r,n)=>{s.onloadend=i=>{var s;return r(null===(s=i.target)||void 0===s?void 0:s.result)},s.onerror=()=>n(),s.readAsText(i)}))},h={type:"importFile",importFileId:c,mimeType:r};yield this.send(h);for(let i=0;i<s.size;i+=d){const r=s.slice(i,i+d,s.type),n={type:"fileChunk",importFileId:c,data:yield readBlob(r),lastChunk:i+d>s.size};yield this.send(n)}const p=yield null===(a=this.importDeferred)||void 0===a?void 0:a.promise;return this.importDeferred=void 0,l.mergeExport(p),l}))}resize(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("resize",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.resizeDeferred=new DeferredPromise;const n=i.getClone();this.viewSizeHeight=n.height,this.viewSizeWidth=n.width;const a={type:"changeViewSize",height:this.viewSizeHeight,width:this.viewSizeWidth};return yield this.send(a),yield null===(r=this.resizeDeferred)||void 0===r?void 0:r.promise,n}))}importPointEvents(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("importPointsEvents",{strokes:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise,this.importPointEventsDeferred=new DeferredPromise;const n={type:"pointerEvents",events:i.map((i=>i.formatToSend()))};this.send(n);const a=yield null===(r=this.importPointEventsDeferred)||void 0===r?void 0:r.promise;return this.importPointEventsDeferred=void 0,__classPrivateFieldGet(this,fe,"f").debug("importPointEvents",{exportPoints:a}),a}))}convert(i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("convert",{model:i,conversionState:s}),yield null===(r=this.initialized)||void 0===r?void 0:r.promise,this.convertDeferred=new DeferredPromise;const a=i.getClone(),l={type:"convert",conversionState:s};yield this.send(l);const d=yield null===(n=this.convertDeferred)||void 0===n?void 0:n.promise;return a.updatePositionReceived(),a.mergeConvert(d),__classPrivateFieldGet(this,fe,"f").debug("convert",{model:a}),a}))}waitForIdle(){var i,s;return __awaiter(this,void 0,void 0,(function*(){yield null===(i=this.initialized)||void 0===i?void 0:i.promise,this.waitForIdleDeferred=new DeferredPromise;return yield this.send({type:"waitForIdle"}),null===(s=this.waitForIdleDeferred)||void 0===s?void 0:s.promise}))}undo(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("undo",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.getClone();this.undoDeferred=new DeferredPromise;yield this.send({type:"undo"});const a=yield null===(r=this.undoDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,fe,"f").debug("undo",{model:n}),this.undoDeferred=void 0,n}))}redo(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("redo",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.getClone();this.redoDeferred=new DeferredPromise;yield this.send({type:"redo"});const a=yield null===(r=this.redoDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),__classPrivateFieldGet(this,fe,"f").debug("redo",{model:a}),this.redoDeferred=void 0,n}))}clear(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,fe,"f").info("clear",{model:i}),yield null===(s=this.initialized)||void 0===s?void 0:s.promise;const n=i.getClone();n.modificationDate=Date.now(),this.clearDeferred=new DeferredPromise;yield this.send({type:"clear"});const a=yield null===(r=this.clearDeferred)||void 0===r?void 0:r.promise;return n.updatePositionReceived(),n.mergeExport(a),this.clearDeferred=void 0,__classPrivateFieldGet(this,fe,"f").info("clear",{model:n}),n}))}close(i,s){this.socket.readyState!==this.socket.OPEN&&this.socket.readyState!==this.socket.CONNECTING||(__classPrivateFieldGet(this,fe,"f").info("close",{code:i,reason:s}),this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.socket.close(i,s))}destroy(){__classPrivateFieldGet(this,fe,"f").info("destroy"),this.connected=void 0,this.initialized=void 0,this.ackDeferred=void 0,this.addStrokeDeferred=void 0,this.exportDeferred=void 0,this.convertDeferred=void 0,this.importDeferred=void 0,this.resizeDeferred=void 0,this.undoDeferred=void 0,this.redoDeferred=void 0,this.clearDeferred=void 0,this.socket&&(this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),this.close(1e3,"Recognizer destroyed"))}}fe=new WeakMap;class CanvasRendererShape{constructor(){ge.set(this,LoggerManager.getLogger("RENDERER")),this.symbols={table:"table",ellipse:"ellipse",line:"line"}}phi(i){let s=(i+Math.PI)%(2*Math.PI)-Math.PI;return s<-Math.PI&&(s+=2*Math.PI),__classPrivateFieldGet(this,ge,"f").debug("phi",{angle:i,returnedAngle:s}),s}drawEllipseArc(i,s){__classPrivateFieldGet(this,ge,"f").debug("drawEllipseArc",{context2D:i,shapeEllipse:s});const{centerPoint:r,maxRadius:n,minRadius:a,orientation:l,startAngle:d,sweepAngle:c}=s,h=Math.cos(l)*n,p=Math.cos(l)*a,v=Math.sin(l)*n,u=Math.sin(l)*a,f=Math.floor(Math.abs(c)/.02),g=[];i.save();try{i.beginPath();for(let s=0;s<=f;s++){const l=d+s/f*c,m=Math.atan2(Math.sin(l)/a,Math.cos(l)/n),_=Math.cos(m),P=Math.sin(m),y=r.x+h*_-u*P,x=r.y+p*P+v*_;0===s?i.moveTo(y,x):i.lineTo(y,x),0!==s&&s!==f||g.push({x:y,y:x})}i.stroke()}catch(i){__classPrivateFieldGet(this,ge,"f").error("drawEllipseArc",{error:i})}finally{i.restore()}return g}drawLine(i,s,r){__classPrivateFieldGet(this,ge,"f").debug("drawLine",{context2D:i,p1:s,p2:r}),i.save();try{i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(r.x,r.y),i.stroke()}catch(i){__classPrivateFieldGet(this,ge,"f").error("drawLine",{error:i})}finally{i.restore()}}drawArrowHead(i,s,r,n){__classPrivateFieldGet(this,ge,"f").debug("drawArrowHead",{context2D:i,headPoint:s,angle:r,length:n});const a=this.phi(r+Math.PI*(7/8)),l=this.phi(r-Math.PI*(7/8));i.save();try{i.fillStyle=i.strokeStyle,i.moveTo(s.x,s.y),i.beginPath(),i.lineTo(s.x+n*Math.cos(a),s.y+n*Math.sin(a)),i.lineTo(s.x+n*Math.cos(l),s.y+n*Math.sin(l)),i.lineTo(s.x,s.y),i.fill()}catch(i){__classPrivateFieldGet(this,ge,"f").error("drawArrowHead",{error:i})}finally{i.restore()}}drawShapeEllipse(i,s){__classPrivateFieldGet(this,ge,"f").debug("drawShapeEllipse",{context2D:i,shapeEllipse:s});const r=this.drawEllipseArc(i,s);"ARROW_HEAD"===(null==s?void 0:s.beginDecoration)&&this.drawArrowHead(i,r[0],s.beginTangentAngle,12),"ARROW_HEAD"===(null==s?void 0:s.endDecoration)&&this.drawArrowHead(i,r[1],s.endTangentAngle,12)}drawShapeLine(i,s){__classPrivateFieldGet(this,ge,"f").debug("drawShapeLine",{context2D:i,shapeLine:s}),this.drawLine(i,s.firstPoint,s.lastPoint),"ARROW_HEAD"===s.beginDecoration&&this.drawArrowHead(i,s.firstPoint,s.beginTangentAngle,12),"ARROW_HEAD"===s.endDecoration&&this.drawArrowHead(i,s.lastPoint,s.endTangentAngle,12)}draw(i,s){switch(__classPrivateFieldGet(this,ge,"f").info("draw",{context2D:i,symbol:s}),i.save(),i.lineWidth=s.style.width,i.strokeStyle=s.style.color,s.type){case this.symbols.table:s.lines.forEach((s=>this.drawLine(i,s.p1,s.p2)));break;case this.symbols.ellipse:this.drawShapeEllipse(i,s);break;case this.symbols.line:this.drawShapeLine(i,s);break;default:__classPrivateFieldGet(this,ge,"f").warn("draw",`${s.type} not implemented`)}}}ge=new WeakMap;class CanvasRendererStroke{constructor(){me.set(this,LoggerManager.getLogger("RENDERER"))}renderArc(i,s,r){__classPrivateFieldGet(this,me,"f").debug("renderArc",{context2d:i,center:s,radius:r}),i.arc(s.x,s.y,r,0,2*Math.PI,!0)}renderLine(i,s,r,n){__classPrivateFieldGet(this,me,"f").debug("renderLine",{context2d:i,begin:s,end:r,width:n});const a=computeLinksPointers(s,computeAngleAxeRadian(s,r),n),l=computeLinksPointers(r,computeAngleAxeRadian(s,r),n);i.moveTo(a[0].x,a[0].y),i.lineTo(l[0].x,l[0].y),i.lineTo(l[1].x,l[1].y),i.lineTo(a[1].x,a[1].y)}renderFinal(i,s,r,n){__classPrivateFieldGet(this,me,"f").debug("renderFinal",{context2d:i,begin:s,end:r,width:n});const a=computeAngleAxeRadian(s,r),l=computeLinksPointers(r,a,n);i.moveTo(l[0].x,l[0].y);for(let s=1;s<=6;s++){const l=a-s*Math.PI/6;i.lineTo(r.x-r.p*n*Math.sin(l),r.y+r.p*n*Math.cos(l))}}renderQuadratic(i,s,r,n,a){__classPrivateFieldGet(this,me,"f").debug("renderQuadratic",{context2d:i,begin:s,end:r,ctrl:n,width:a});const l=computeLinksPointers(s,computeAngleAxeRadian(s,n),a),d=computeLinksPointers(r,computeAngleAxeRadian(n,r),a),c=computeLinksPointers(n,computeAngleAxeRadian(s,r),a);i.moveTo(l[0].x,l[0].y),i.quadraticCurveTo(c[0].x,c[0].y,d[0].x,d[0].y),i.lineTo(d[1].x,d[1].y),i.quadraticCurveTo(c[1].x,c[1].y,l[1].x,l[1].y)}draw(i,s){__classPrivateFieldGet(this,me,"f").info("draw",{context2d:i,stroke:s});const r=s.pointers.length,n=r-2,a=s.style.width>0?s.style.width:i.lineWidth,l=s.style.color?s.style.color:i.strokeStyle,d=s.pointers[0];i.save();try{if(i.beginPath(),r<3)this.renderArc(i,d,.6*a);else{this.renderArc(i,d,a*d.p);const l=computeMiddlePointer(d,s.pointers[1]);this.renderLine(i,d,l,a);for(let r=0;r<n;r++){const n=computeMiddlePointer(s.pointers[r],s.pointers[r+1]),l=computeMiddlePointer(s.pointers[r+1],s.pointers[r+2]),d=s.pointers[r+1];this.renderQuadratic(i,n,l,d,a)}const c=computeMiddlePointer(s.pointers[r-2],s.pointers[r-1]),h=s.pointers[r-1];this.renderLine(i,c,h,a);const p=s.pointers[r-2],v=s.pointers[r-1];this.renderFinal(i,p,v,a)}i.closePath(),void 0!==l&&(i.fillStyle=l,i.fill()),i.save()}catch(i){__classPrivateFieldGet(this,me,"f").error("draw",{error:i})}finally{i.restore()}}}me=new WeakMap;class CanvasRendererText{constructor(){_e.set(this,LoggerManager.getLogger("RENDERER")),this.symbols={char:"char",string:"string",textLine:"textLine"}}drawUnderline(i,s,r){__classPrivateFieldGet(this,_e,"f").debug("#drawUnderline",{context2D:i,textUnderline:s,underline:r}),i.save();try{const n=s.data.width/s.label.length,a={x:s.data.topLeftPoint.x+r.data.firstCharacter*n,y:s.data.topLeftPoint.y+s.data.height},l={x:s.data.topLeftPoint.x+r.data.lastCharacter*n,y:s.data.topLeftPoint.y+s.data.height};i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(l.x,l.y),i.stroke()}catch(i){__classPrivateFieldGet(this,_e,"f").error("#drawUnderline",{error:i})}finally{i.restore()}}drawText(i,s){__classPrivateFieldGet(this,_e,"f").debug("#drawText",{context2D:i,text:s}),i.save();try{i.font=`${s.data.textHeight}px serif`,i.textAlign="CENTER"===s.data.justificationType?"center":"left",i.textBaseline="bottom",i.fillStyle=i.strokeStyle,i.fillText(s.label,s.data.topLeftPoint.x,s.data.topLeftPoint.y+s.data.height)}catch(i){__classPrivateFieldGet(this,_e,"f").error("#drawText",{error:i})}finally{i.restore()}}drawTextLine(i,s){__classPrivateFieldGet(this,_e,"f").debug("#drawTextLine",{context2D:i,textUnderline:s}),this.drawText(i,s),s.underlineList.forEach((r=>{this.drawUnderline(i,s,r)}))}draw(i,s){switch(__classPrivateFieldGet(this,_e,"f").info("draw",{context2D:i,symbol:s}),i.lineWidth=s.style.width,i.strokeStyle=s.style.color,s.type){case this.symbols.char:case this.symbols.string:this.drawText(i,s);break;case this.symbols.textLine:this.drawTextLine(i,s);break;default:__classPrivateFieldGet(this,_e,"f").warn("draw",`${s.type} not implemented`)}}}_e=new WeakMap;class CanvasRenderer{constructor(i){Pe.set(this,LoggerManager.getLogger("RENDERER")),__classPrivateFieldGet(this,Pe,"f").info("constructor",{config:i}),this.configuration=i,this.strokeRenderer=new CanvasRendererStroke,this.shapeRenderer=new CanvasRendererShape,this.textRenderer=new CanvasRendererText}createCanvas(i){__classPrivateFieldGet(this,Pe,"f").debug("createCanvas",{type:i});const s=document.createElement("canvas");return s.id=i,s.classList.add(i),s.classList.add("ms-canvas"),s}resizeContent(){const i=window.devicePixelRatio;[this.context.renderingCanvas,this.context.capturingCanvas].forEach((s=>{var r;const n=s.parentNode,a=Math.max(this.configuration.minWidth,n.clientWidth),l=Math.max(this.configuration.minHeight,n.clientHeight);s.width=a*i,s.height=l*i,null===(r=s.getContext("2d"))||void 0===r||r.scale(i,i),s.style.width=`${a}px`,s.style.height=`${l}px`}))}drawSymbol(i,s){if(__classPrivateFieldGet(this,Pe,"f").debug("drawSymbol",{symbol:s}),"stroke"===s.type){const r=s;"eraser"!==r.pointerType&&this.strokeRenderer.draw(i,r)}else Object.keys(this.textRenderer.symbols).includes(s.type)?this.textRenderer.draw(i,s):Object.keys(this.shapeRenderer.symbols).includes(s.type)?this.shapeRenderer.draw(i,s):__classPrivateFieldGet(this,Pe,"f").warn("drawSymbol",`symbol type unknow: ${s.type}`)}init(i){__classPrivateFieldGet(this,Pe,"f").info("init",{element:i});const s=this.createCanvas("ms-rendering-canvas");i.appendChild(s);const r=this.createCanvas("ms-capture-canvas");i.appendChild(r),this.context={parent:i,renderingCanvas:s,renderingCanvasContext:s.getContext("2d"),capturingCanvas:r,capturingCanvasContext:r.getContext("2d")},this.resizeContent()}drawModel(i){var s;__classPrivateFieldGet(this,Pe,"f").info("drawModel",{model:i}),null===(s=this.context.renderingCanvasContext)||void 0===s||s.clearRect(0,0,this.context.renderingCanvas.width,this.context.renderingCanvas.height),i.symbols.forEach((i=>this.drawSymbol(this.context.renderingCanvasContext,i))),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height)}drawPendingStroke(i){__classPrivateFieldGet(this,Pe,"f").info("drawPendingStroke",{stroke:i}),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height),i&&"eraser"!==(null==i?void 0:i.pointerType)&&this.strokeRenderer.draw(this.context.capturingCanvasContext,i)}resize(i){__classPrivateFieldGet(this,Pe,"f").info("resize",{model:i}),this.resizeContent(),this.drawModel(i)}destroy(){__classPrivateFieldGet(this,Pe,"f").info("destroy"),this.context.parent&&(this.context.parent.innerHTML="")}}Pe=new WeakMap;class SVGStroker{getArcPath(i,s){return[`M ${i.x},${i.y}`,`m ${-s},0`,`a ${s},${s} 0 1 0 ${2*s},0`,`a ${s},${s} 0 1 0 ${-2*s},0`].join(" ")}getLinePath(i,s,r){const n=computeLinksPointers(i,computeAngleAxeRadian(i,s),r),a=computeLinksPointers(s,computeAngleAxeRadian(i,s),r);return[`M ${n[0].x},${n[0].y}`,`L ${a[0].x},${a[0].y}`,`L ${a[1].x},${a[1].y}`,`L ${n[1].x},${n[1].y}`].join(" ")}getFinalPath(i,s,r){const n=computeAngleAxeRadian(i,s),a=computeLinksPointers(s,n,r),l=[`M ${a[0].x},${a[0].y}`];for(let i=1;i<=6;i++){const a=n-i*(Math.PI/6);l.push(`L ${s.x-s.p*r*Math.sin(a)},${s.y+s.p*r*Math.cos(a)}`)}return l.join(" ")}getQuadraticPath(i,s,r,n){const a=computeLinksPointers(i,computeAngleAxeRadian(i,r),n),l=computeLinksPointers(s,computeAngleAxeRadian(r,s),n),d=computeLinksPointers(r,computeAngleAxeRadian(i,s),n);return[`M ${a[0].x},${a[0].y}`,`Q ${d[0].x},${d[0].y} ${l[0].x},${l[0].y}`,`L ${l[1].x},${l[1].y}`,`Q ${d[1].x},${d[1].y} ${a[1].x},${a[1].y}`].join(" ")}buildSVGPath(i){const s=i.pointers.length,r=i.style.width,n=s-2,a=i.pointers[0],l=[];if(s<3)l.push(this.getArcPath(a,.6*r));else{l.push(this.getArcPath(a,r*a.p)),l.push(this.getLinePath(a,computeMiddlePointer(a,i.pointers[1]),r));for(let s=0;s<n;s++){const n=computeMiddlePointer(i.pointers[s],i.pointers[s+1]),a=computeMiddlePointer(i.pointers[s+1],i.pointers[s+2]),d=i.pointers[s+1];l.push(this.getQuadraticPath(n,a,d,r))}const d=i.pointers[s-2],c=i.pointers[s-1];l.push(this.getLinePath(computeMiddlePointer(d,c),c,r)),l.push(this.getFinalPath(d,c,r))}return l.join(" ")}drawStroke(i,s,r){const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.classList.add("pending-stroke"),n.setAttribute("id",s.id),n.setAttribute("type",s.pointerType),null==r||r.forEach((i=>{n.setAttribute(i.name,i.value)}));const a=this.buildSVGPath(s);n.setAttribute("d",`${a}Z`),i.appendChild(n)}}class WSSVGRenderer{constructor(i){ye.set(this,LoggerManager.getLogger("RENDERER")),__classPrivateFieldGet(this,ye,"f").info("constructor",{config:i}),this.config=i,this.stroker=new SVGStroker}init(i){__classPrivateFieldGet(this,ye,"f").info("init",{element:i}),i.style.fontSize="10px",this.context={parent:i}}drawStroke(i,s){let r;"eraser"===s.pointerType?(s.style.width=20,r="fill:grey;stroke:transparent;shadowBlur:5;opacity:0.2;"):r=`fill:${s.style.color};stroke:transparent;`,this.stroker.drawStroke(i,s,[{name:"style",value:r}])}replaceAll(i,s){const r=this.context.parent.querySelector(`svg[data-layer="${i}"]`);null==r||r.remove(),this.context.parent.insertAdjacentHTML("beforeend",s.svg);const n=this.context.parent.querySelector(`svg[data-layer="${i}"]`);if("MODEL"===i){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id="pendingStrokes",n.appendChild(i)}}replaceElement(i){const s=this.context.parent.querySelector(`#${i.id}`);if(s){const r=s.parentNode;null==s||s.remove(),null==r||r.insertAdjacentHTML("beforeend",i.svg)}}appendChild(i,s){const r=s.parentId?`#${s.parentId}`:`svg[data-layer="${i}"]`,n=this.context.parent.querySelector(r);null==n||n.insertAdjacentHTML("beforeend",s.svg)}removeChild(i){var s;null===(s=this.context.parent.querySelector(`#${i.parentId} > *:nth-child(${i.index+1})`))||void 0===s||s.remove()}removeElement(i){const s=this.context.parent.querySelector(`#${i.id}`);s&&(i.id.includes("s")||i.id.includes("MODEL")?s.remove():(s.setAttribute("class","removed-stroke"),setTimeout((()=>{null==s||s.remove()}),100)))}insertBefore(i){const s=this.context.parent.querySelector(`#${i.refId}`);null==s||s.insertAdjacentHTML("beforebegin",i.svg)}setAttribute(i){const s=i.id?`#${i.id}`:"svg",r=this.context.parent.querySelector(s);null==r||r.setAttribute(i.name,i.value)}removeAttribute(i){const s=i.id?`#${i.id}`:"svg",r=this.context.parent.querySelector(s);null==r||r.removeAttribute(i.name)}updateLayer(i,s){switch(__classPrivateFieldGet(this,ye,"f").info("updateLayer",{layerName:i,update:s}),s.type){case"REPLACE_ALL":this.replaceAll(i,s);break;case"REPLACE_ELEMENT":this.replaceElement(s);break;case"APPEND_CHILD":this.appendChild(i,s);break;case"REMOVE_ELEMENT":this.removeElement(s);break;case"REMOVE_CHILD":this.removeChild(s);break;case"INSERT_BEFORE":this.insertBefore(s);break;case"SET_ATTRIBUTE":this.setAttribute(s);break;case"REMOVE_ATTRIBUTE":this.removeAttribute(s);break;default:__classPrivateFieldGet(this,ye,"f").warn("updateLayer",`update.type unknow ${s.type}`)}}updatesLayer(i,s){__classPrivateFieldGet(this,ye,"f").info("updatesLayer",{layerName:i,updates:s}),s.forEach((s=>this.updateLayer(i,s))),this.clearPendingStroke()}clearPendingStroke(){__classPrivateFieldGet(this,ye,"f").info("clearPendingStroke");const i=this.context.parent.querySelector("#pendingStrokes");i&&(i.innerHTML="")}drawPendingStroke(i){if(__classPrivateFieldGet(this,ye,"f").info("drawPendingStroke",{stroke:i}),i){const s=this.context.parent.querySelector("#pendingStrokes");if(s){const r=s.querySelector(`#${null==i?void 0:i.id}`);r&&r.remove(),this.drawStroke(s,i)}}}clearErasingStrokes(){this.context.parent.querySelectorAll("[type=eraser]").forEach((i=>{i.remove()}))}resize(i){__classPrivateFieldGet(this,ye,"f").info("resize",{model:i});const s=this.context.parent.getBoundingClientRect(),r=this.context.parent.querySelectorAll("svg"),n=Math.max(s.width,i.width),a=Math.max(s.height,i.height);r.forEach((i=>{i.setAttribute("viewBox",`0 0 ${n}, ${a}`),i.setAttribute("width",`${n}px`),i.setAttribute("height",`${a}px`)}))}destroy(){var i;__classPrivateFieldGet(this,ye,"f").info("destroy",{context:this.context}),(null===(i=this.context)||void 0===i?void 0:i.parent)&&this.context.parent.querySelectorAll("svg").forEach((i=>i.remove()))}}ye=new WeakMap;class UndoRedoContext{constructor(i){this.stackIndex=0,this.possibleUndoCount=0,this.canRedo=!1,this.canUndo=!1,this.empty=!0,this.stack=[i.getClone()]}}class UndoRedoManager{constructor(i,s){xe.set(this,LoggerManager.getLogger("UNDO_REDO")),__classPrivateFieldGet(this,xe,"f").info("constructor",{configuration:i,model:s}),this.configuration=i,this.context=new UndoRedoContext(s)}get internalEvent(){return InternalEvent.getInstance()}updateCanUndoRedo(){this.context.canRedo=this.context.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0;const i=this.context.stack[this.context.stackIndex];this.context.empty=0===i.symbols.length}addModelToStack(i){__classPrivateFieldGet(this,xe,"f").info("addModelToStack",{model:i}),this.context.stackIndex+1<this.context.stack.length&&this.context.stack.splice(this.context.stackIndex+1),this.context.stack.push(i.getClone()),this.context.stackIndex=this.context.stack.length-1,this.context.stack.length>this.configuration.maxStackSize&&(this.context.stack.shift(),this.context.stackIndex--),this.updateCanUndoRedo(),this.internalEvent.emitContextChange(this.context)}removeLastModelInStack(){__classPrivateFieldGet(this,xe,"f").info("removeLastModelInStack"),this.context.stackIndex===this.context.stack.length-1&&this.context.stackIndex--,this.context.stack.pop(),this.updateCanUndoRedo()}updateModelInStack(i){__classPrivateFieldGet(this,xe,"f").info("updateModelInStack",{model:i});const s=this.context.stack.findIndex((s=>s.modificationDate===i.modificationDate));s>-1&&this.context.stack.splice(s,1,i.getClone()),this.updateCanUndoRedo(),this.internalEvent.emitContextChange(this.context)}undo(){__classPrivateFieldGet(this,xe,"f").info("undo"),this.context.canUndo&&(this.context.stackIndex--,this.updateCanUndoRedo(),this.internalEvent.emitContextChange(this.context));const i=this.context.stack[this.context.stackIndex].getClone();return __classPrivateFieldGet(this,xe,"f").debug("undo",i),i}redo(){__classPrivateFieldGet(this,xe,"f").info("redo"),this.context.canRedo&&(this.context.stackIndex++,this.updateCanUndoRedo(),this.internalEvent.emitContextChange(this.context));const i=this.context.stack[this.context.stackIndex].getClone();return __classPrivateFieldGet(this,xe,"f").debug("redo",i),i}reset(i){__classPrivateFieldGet(this,xe,"f").info("reset",{model:i}),this.context=new UndoRedoContext(i),this.internalEvent.emitContextChange(this.context)}}xe=new WeakMap;class RestBehaviors{constructor(i){this.name="RestBehaviors",we.set(this,LoggerManager.getLogger("BEHAVIORS")),be.set(this,void 0),Se.set(this,void 0),Fe.set(this,void 0),Ge.set(this,void 0),__classPrivateFieldGet(this,we,"f").info("constructor",{options:i}),__classPrivateFieldSet(this,be,new Configuration(null==i?void 0:i.configuration),"f"),this.styleManager=new StyleManager(null==i?void 0:i.penStyle,null==i?void 0:i.theme),this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,be,"f").grabber),this.renderer=new CanvasRenderer(__classPrivateFieldGet(this,be,"f").rendering),this.recognizer=new RestRecognizer(__classPrivateFieldGet(this,be,"f").server,__classPrivateFieldGet(this,be,"f").recognition),this.intention="write",__classPrivateFieldSet(this,Se,new Model,"f"),this.undoRedoManager=new UndoRedoManager(__classPrivateFieldGet(this,be,"f")["undo-redo"],this.model)}onPointerDown(i,s){var r;__classPrivateFieldGet(this,we,"f").info("onPointerDown",{intention:this.intention,evt:i,point:s});const{pointerType:n}=i,a=Object.assign({},null===(r=this.theme)||void 0===r?void 0:r.ink,this.currentPenStyle);switch(this.intention){case"erase":this.model.removeStrokesFromPoint(s).length>0&&this.renderer.drawModel(this.model);break;case"write":this.model.initCurrentStroke(s,i.pointerId,n,a),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,we,"f").warn("#onPointerDown",`onPointerDown intention unknow: "${this.intention}"`)}}onPointerMove(i,s){switch(__classPrivateFieldGet(this,we,"f").info("onPointerMove",{intention:this.intention,point:s}),this.intention){case"erase":this.model.removeStrokesFromPoint(s).length>0&&this.renderer.drawModel(this.model);break;case"write":this.model.appendToCurrentStroke(s),this.drawCurrentStroke();break;default:__classPrivateFieldGet(this,we,"f").warn("#onPointerMove",`onPointerMove intention unknow: "${this.intention}"`)}}onPointerUp(i,s){var r;return __awaiter(this,void 0,void 0,(function*(){switch(__classPrivateFieldGet(this,we,"f").info("onPointerUp",{intention:this.intention,point:s}),this.intention){case"erase":this.model.removeStrokesFromPoint(s),(null===(r=this.context.stack.at(-1))||void 0===r?void 0:r.modificationDate)!==this.model.modificationDate&&(yield this.updateModelRendering());break;case"write":this.model.endCurrentStroke(s),yield this.updateModelRendering();break;default:__classPrivateFieldGet(this,we,"f").warn("#onPointerUp",`onPointerUp intention unknow: "${this.intention}"`)}}))}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,Se,"f")}get context(){return this.undoRedoManager.context}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),Promise.resolve()}))}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("setPenStyleClasses",{penStyleClasses:i}),this.styleManager.setPenStyleClasses(i),Promise.resolve()}))}get theme(){return this.styleManager.theme}setTheme(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),Promise.resolve()}))}get configuration(){return __classPrivateFieldGet(this,be,"f")}init(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("init",{domElement:i}),this.model.width=Math.max(i.clientWidth,__classPrivateFieldGet(this,be,"f").rendering.minWidth),this.model.height=Math.max(i.clientHeight,__classPrivateFieldGet(this,be,"f").rendering.minHeight),this.undoRedoManager.updateModelInStack(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),Promise.resolve()}))}drawCurrentStroke(){__classPrivateFieldGet(this,we,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol}),this.renderer.drawPendingStroke(this.model.currentSymbol)}updateModelRendering(){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,we,"f").info("updateModelRendering"),this.renderer.drawModel(this.model);const i=new DeferredPromise;if(this.undoRedoManager.addModelToStack(this.model),"DEMAND"!==__classPrivateFieldGet(this,be,"f").triggers.exportContent){clearTimeout(__classPrivateFieldGet(this,Ge,"f"));let s=this.model.getClone();__classPrivateFieldSet(this,Ge,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{s=yield this.recognizer.export(s),this.undoRedoManager.updateModelInStack(s),this.model.modificationDate===s.modificationDate&&(this.model.exports=s.exports),i.resolve(this.model)}catch(s){__classPrivateFieldGet(this,we,"f").error("updateModelRendering",{error:s}),this.internalEvent.emitError(s),i.reject(s)}}))),"QUIET_PERIOD"===__classPrivateFieldGet(this,be,"f").triggers.exportContent?__classPrivateFieldGet(this,be,"f").triggers.exportContentDelay:0),"f")}else i.resolve(this.model);return yield i.promise,this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,we,"f").debug("updateModelRendering",this.model.exports),i.promise}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,we,"f").info("export",{mimeTypes:i});const s=yield this.recognizer.export(this.model.getClone(),i);return this.model.modificationDate===s.modificationDate&&this.model.mergeExport(s.exports),this.undoRedoManager.updateModelInStack(s),__classPrivateFieldGet(this,we,"f").debug("export",this.model),this.model}))}convert(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,we,"f").info("convert",{conversionState:i,requestedMimeTypes:s});const r=yield this.recognizer.convert(this.model,i,s);return Object.assign(__classPrivateFieldGet(this,Se,"f"),r),__classPrivateFieldGet(this,we,"f").debug("convert",this.model),this.model}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){const s=[];i.forEach(((i,r)=>{var n,a;let l=!0;const d=new Stroke(i.style||ee,i.pointerId||1);if(i.id&&(d.id=i.id),!(null===(n=i.pointers)||void 0===n?void 0:n.length))return s.push(`stroke ${r+1} has not pointers`),void(l=!1);null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(!i)return s.push(`stroke ${r+1} has no pointer at ${n}`),void(l=!1);const a={p:i.p||1,t:i.t||n,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${r+1} has no x at pointer at ${n}`),void(l=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${r+1} has no y at pointer at ${n}`),void(l=!1)):(a.y=i.y,void(l&&d.pointers.push(a))))})),l&&this.model.addStroke(d)})),s.length&&this.internalEvent.emitError(new Error(s.join("\n")));try{const i=yield this.updateModelRendering();return Object.assign(__classPrivateFieldGet(this,Se,"f"),i),this.model}catch(i){throw this.internalEvent.emitError(i),i}}))}resize(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,we,"f").info("resize",{height:i,width:s});const r=new DeferredPromise;return this.model.height=i,this.model.width=s,this.renderer.resize(this.model),this.model.symbols.length?(clearTimeout(__classPrivateFieldGet(this,Fe,"f")),__classPrivateFieldSet(this,Fe,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){const i=yield this.recognizer.resize(this.model);r.resolve(i)}))),__classPrivateFieldGet(this,be,"f").triggers.resizeTriggerDelay),"f")):r.resolve(this.model),__classPrivateFieldSet(this,Se,yield r.promise,"f"),__classPrivateFieldGet(this,we,"f").debug("resize",{model:this.model}),this.internalEvent.emitExported(this.model.exports),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("undo"),__classPrivateFieldSet(this,Se,this.undoRedoManager.undo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Se,"f")),__classPrivateFieldSet(this,Se,yield this.recognizer.export(__classPrivateFieldGet(this,Se,"f")),"f"),this.undoRedoManager.updateModelInStack(__classPrivateFieldGet(this,Se,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Se,"f").exports),__classPrivateFieldGet(this,we,"f").debug("undo",__classPrivateFieldGet(this,Se,"f")),__classPrivateFieldGet(this,Se,"f")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("redo"),__classPrivateFieldSet(this,Se,this.undoRedoManager.redo(),"f"),this.renderer.drawModel(__classPrivateFieldGet(this,Se,"f")),__classPrivateFieldSet(this,Se,yield this.recognizer.export(__classPrivateFieldGet(this,Se,"f")),"f"),this.undoRedoManager.updateModelInStack(__classPrivateFieldGet(this,Se,"f")),this.internalEvent.emitExported(__classPrivateFieldGet(this,Se,"f").exports),__classPrivateFieldGet(this,we,"f").debug("redo",__classPrivateFieldGet(this,Se,"f")),__classPrivateFieldGet(this,Se,"f")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("clear"),this.model.clear(),this.undoRedoManager.addModelToStack(this.model),this.renderer.drawModel(this.model),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,we,"f").debug("clear",this.model),this.model}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,we,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),Promise.resolve()}))}}we=new WeakMap,be=new WeakMap,Se=new WeakMap,Fe=new WeakMap,Ge=new WeakMap;class WSBehaviors{constructor(i){this.name="WSBehaviors",Ee.set(this,LoggerManager.getLogger("BEHAVIORS")),Ce.set(this,void 0),ke.set(this,void 0),Me.set(this,void 0),__classPrivateFieldGet(this,Ee,"f").info("constructor",{options:i}),__classPrivateFieldSet(this,Ce,new Configuration(null==i?void 0:i.configuration),"f"),this.styleManager=new StyleManager(null==i?void 0:i.penStyle,null==i?void 0:i.theme),this.grabber=new PointerEventGrabber(__classPrivateFieldGet(this,Ce,"f").grabber),this.renderer=new WSSVGRenderer(__classPrivateFieldGet(this,Ce,"f").rendering),this.recognizer=new WSRecognizer(__classPrivateFieldGet(this,Ce,"f").server,__classPrivateFieldGet(this,Ce,"f").recognition),this.intention="write",__classPrivateFieldSet(this,ke,new Model,"f"),this.undoRedoManager=new UndoRedoManager(__classPrivateFieldGet(this,Ce,"f")["undo-redo"],this.model)}get internalEvent(){return InternalEvent.getInstance()}get model(){return __classPrivateFieldGet(this,ke,"f")}get context(){return this.undoRedoManager.context}get configuration(){return __classPrivateFieldGet(this,Ce,"f")}get currentPenStyle(){return this.styleManager.currentPenStyle}get penStyle(){return this.styleManager.penStyle}setPenStyle(i){return __classPrivateFieldGet(this,Ee,"f").info("setPenStyle",{penStyle:i}),this.styleManager.setPenStyle(i),__classPrivateFieldGet(this,Ee,"f").debug("setPenStyle",this.styleManager.penStyle),this.recognizer.setPenStyle(this.styleManager.penStyle)}get penStyleClasses(){return this.styleManager.penStyleClasses}setPenStyleClasses(i){return __classPrivateFieldGet(this,Ee,"f").info("setPenStyleClasses",{penClass:i}),this.styleManager.setPenStyleClasses(i),__classPrivateFieldGet(this,Ee,"f").debug("setPenStyleClasses",this.styleManager.penStyleClasses),this.recognizer.setPenStyleClasses(this.styleManager.penStyleClasses)}get theme(){return this.styleManager.theme}setTheme(i){return __classPrivateFieldGet(this,Ee,"f").info("setTheme",{theme:i}),this.styleManager.setTheme(i),__classPrivateFieldGet(this,Ee,"f").debug("setTheme",this.styleManager.theme),this.recognizer.setTheme(this.styleManager.theme)}onExport(i){__classPrivateFieldGet(this,Ee,"f").debug("onExport",{exports:i}),this.model.mergeExport(i)}onPointerDown(i,s){var r;__classPrivateFieldGet(this,Ee,"f").info("onPointerDown",{intention:this.intention,evt:i,point:s});let{pointerType:n}=i;const a=Object.assign({},null===(r=this.theme)||void 0===r?void 0:r.ink,this.currentPenStyle);"erase"===this.intention&&(n="eraser"),this.model.initCurrentStroke(s,i.pointerId,n,a),this.drawCurrentStroke()}onPointerMove(i,s){__classPrivateFieldGet(this,Ee,"f").info("onPointerMove",{intention:this.intention,point:s}),this.model.appendToCurrentStroke(s),this.drawCurrentStroke()}onPointerUp(i,s){return __awaiter(this,void 0,void 0,(function*(){try{__classPrivateFieldGet(this,Ee,"f").info("onPointerUp",{intention:this.intention,point:s}),this.model.endCurrentStroke(s),yield this.synchronizeModelWithBackend()}catch(i){this.internalEvent.emitError(i)}}))}onSVGPatch(i){__classPrivateFieldGet(this,Ee,"f").info("onSVGPatch",{evt:i}),this.renderer.updatesLayer(i.layer,i.updates)}init(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ee,"f").info("init",{domElement:i});const s=window.getComputedStyle(i);this.model.width=Math.max(parseInt(s.width.replace("px","")),__classPrivateFieldGet(this,Ce,"f").rendering.minWidth),this.model.height=Math.max(parseInt(s.height.replace("px","")),__classPrivateFieldGet(this,Ce,"f").rendering.minHeight),this.undoRedoManager.updateModelInStack(this.model),this.renderer.init(i),this.grabber.attach(i),this.grabber.onPointerDown=this.onPointerDown.bind(this),this.grabber.onPointerMove=this.onPointerMove.bind(this),this.grabber.onPointerUp=this.onPointerUp.bind(this),this.internalEvent.addExportedListener(this.onExport.bind(this)),this.internalEvent.addSVGPatchListener(this.onSVGPatch.bind(this)),yield this.recognizer.init(this.model.height,this.model.width),yield this.setPenStyle(this.penStyle),yield this.setTheme(this.theme),yield this.setPenStyleClasses(this.penStyleClasses)}))}drawCurrentStroke(){__classPrivateFieldGet(this,Ee,"f").debug("drawCurrentStroke",{stroke:this.model.currentSymbol});const i=this.model.currentSymbol;i&&this.renderer.drawPendingStroke(i)}synchronizeModelWithBackend(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ee,"f").info("synchronizeModelWithBackend"),"DEMAND"!==__classPrivateFieldGet(this,Ce,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent(),this.undoRedoManager.addModelToStack(this.model),this.renderer.clearErasingStrokes();const s=yield this.recognizer.addStrokes(i);this.model.mergeExport(s),this.undoRedoManager.updateModelInStack(this.model)}return __classPrivateFieldGet(this,Ee,"f").debug("synchronizeModelWithBackend",this.model),this.model}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){return this.recognizer.waitForIdle()}))}export(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ee,"f").info("export",{mimeTypes:i});try{if("DEMAND"===__classPrivateFieldGet(this,Ce,"f").triggers.exportContent){const i=this.model.extractUnsentStrokes();this.model.updatePositionSent();const s=yield this.recognizer.addStrokes(i);return this.model.updatePositionReceived(),this.model.mergeExport(s),__classPrivateFieldGet(this,Ee,"f").debug("export",this.model),this.model}return this.recognizer.export(this.model,i)}catch(i){return __classPrivateFieldGet(this,Ee,"f").error("export",{error:i}),this.internalEvent.emitError(i),Promise.reject(i)}}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Ee,"f").info("convert",{conversionState:i}),this.undoRedoManager.addModelToStack(this.model),this.context.stack.push(this.model.getClone()),__classPrivateFieldSet(this,ke,yield this.recognizer.convert(this.model,i),"f"),__classPrivateFieldGet(this,Ee,"f").debug("convert",this.model),this.undoRedoManager.addModelToStack(this.model),this.model}))}import(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ee,"f").info("import",{data:i,mimeType:s}),this.context.stack.push(this.model.getClone());const r=yield this.recognizer.import(this.model,i,s);return this.undoRedoManager.addModelToStack(r),r}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ee,"f").info("importPointEvents",{strokes:i});const s=[],r=i.map(((i,r)=>{var n,a;const l=new Stroke(i.style||ee,i.pointerId||1);i.id&&(l.id=i.id),i.pointerType&&(l.pointerType=i.pointerType),(null===(n=i.pointers)||void 0===n?void 0:n.length)||s.push(`stroke ${r+1} has not pointers`);let d=!0;return null===(a=i.pointers)||void 0===a||a.forEach(((i,n)=>{if(d=!0,!i)return void s.push(`stroke ${r+1} has no pointer at ${n}`);const a={p:i.p||1,t:i.t||n,x:0,y:0};null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${r+1} has no x at pointer at ${n}`),d=!1):a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${r+1} has no y at pointer at ${n}`),d=!1):a.y=i.y,d&&l.pointers.push(a)})),l}));s.length&&this.internalEvent.emitError(new Error(s.join("\n"))),r.map((i=>this.model.addStroke(i)));const n=yield this.recognizer.importPointEvents(r);return this.model.mergeExport(n),__classPrivateFieldGet(this,Ee,"f").debug("importPointEvents",this.model),this.model}))}resize(i,s){return __awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,Ee,"f").info("resize",{height:i,width:s});const r=new DeferredPromise;this.model.height=i,this.model.width=s;const n=this.model.getClone();return this.renderer.resize(n),clearTimeout(__classPrivateFieldGet(this,Me,"f")),__classPrivateFieldSet(this,Me,setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{const i=yield this.recognizer.resize(n);r.resolve(i)}catch(n){__classPrivateFieldGet(this,Ee,"f").error("resize",{height:i,width:s,error:n}),r.reject(n)}}))),__classPrivateFieldGet(this,Ce,"f").triggers.resizeTriggerDelay),"f"),__classPrivateFieldSet(this,ke,yield r.promise,"f"),this.internalEvent.emitExported(this.model.exports),__classPrivateFieldGet(this,Ee,"f").debug("resize",this.model),this.model}))}undo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ee,"f").info("undo"),this.context.canUndo)return __classPrivateFieldSet(this,ke,this.undoRedoManager.undo(),"f"),this.recognizer.undo(this.model);throw new Error("Undo not allowed")}))}redo(){return __awaiter(this,void 0,void 0,(function*(){if(__classPrivateFieldGet(this,Ee,"f").info("redo"),this.context.canRedo)return __classPrivateFieldSet(this,ke,this.undoRedoManager.redo(),"f"),__classPrivateFieldGet(this,Ee,"f").debug("undo",__classPrivateFieldGet(this,ke,"f")),this.recognizer.redo(this.model);throw new Error("Redo not allowed")}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Ee,"f").info("clear"),this.model.clear(),this.undoRedoManager.addModelToStack(this.model),this.recognizer.clear(this.model)}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return __classPrivateFieldGet(this,Ee,"f").info("destroy"),this.grabber.detach(),this.renderer.destroy(),this.recognizer.destroy(),Promise.resolve()}))}}Ee=new WeakMap,Ce=new WeakMap,ke=new WeakMap,Me=new WeakMap;class SmartGuide{constructor(){Te.add(this),Le.set(this,void 0),De.set(this,void 0),Re.set(this,void 0),Ae.set(this,void 0),Ie.set(this,void 0),Ne.set(this,void 0),Oe.set(this,void 0),ze.set(this,void 0),je.set(this,void 0),We.set(this,void 0),Ue.set(this,void 0),$e.set(this,void 0),He.set(this,LoggerManager.getLogger("SMARTGUIDE")),it.set(this,(i=>{var s,r;__classPrivateFieldGet(this,He,"f").info("showCandidates",{target:i});const n=parseInt(i.id.replace("word-","").replace(this.uuid,"")),a=null===(s=this.jiix)||void 0===s?void 0:s.words;this.wordToChange=a[n],this.wordToChange&&(this.wordToChange.id=n.toString(),__classPrivateFieldGet(this,Oe,"f").innerHTML="",(null===(r=this.wordToChange)||void 0===r?void 0:r.candidates)&&(__classPrivateFieldGet(this,Oe,"f").style.display="flex",this.wordToChange.candidates.forEach(((i,s)=>{var r;(null===(r=this.wordToChange)||void 0===r?void 0:r.label)===i?__classPrivateFieldGet(this,Oe,"f").innerHTML+=`<span id="cdt-${s}${this.uuid}" class="selected-word">${i}</span>`:__classPrivateFieldGet(this,Oe,"f").innerHTML+=`<span id="cdt-${s}${this.uuid}">${i}</span>`})),i.appendChild(__classPrivateFieldGet(this,Oe,"f"))))})),ot.set(this,(i=>{__classPrivateFieldGet(this,He,"f").info("onClickEllipsis",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,$e,"f")?__classPrivateFieldGet(this,Te,"m",nt).call(this):__classPrivateFieldGet(this,Te,"m",rt).call(this),__classPrivateFieldGet(this,Te,"m",st).call(this)})),at.set(this,(i=>{__classPrivateFieldGet(this,He,"f").info("onClickConvert",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitConvert(),__classPrivateFieldGet(this,Te,"m",nt).call(this)})),ct.set(this,(i=>__awaiter(this,void 0,void 0,(function*(){__classPrivateFieldGet(this,He,"f").info("onClickCopy",{evt:i}),i.preventDefault(),i.stopPropagation();try{__classPrivateFieldGet(this,Te,"m",nt).call(this);let i="Nothing to copy";if(__classPrivateFieldGet(this,Ae,"f").innerText){i=`"${__classPrivateFieldGet(this,Ae,"f").innerText}" copied to clipboard`;const s=__classPrivateFieldGet(this,Te,"m",lt).call(this,__classPrivateFieldGet(this,Ae,"f").innerText);__classPrivateFieldGet(this,Re,"f").appendChild(s),__classPrivateFieldGet(this,Te,"m",dt).call(this,s),document.execCommand("copy"),s.remove()}this.internalEvent.emitNotif({message:i,timeout:1500})}catch(i){__classPrivateFieldGet(this,He,"f").error("onClickCopy",i),this.internalEvent.emitError(i)}})))),ht.set(this,(i=>{__classPrivateFieldGet(this,He,"f").info("onClickDelete",{evt:i}),i.preventDefault(),i.stopPropagation(),this.internalEvent.emitClear(),__classPrivateFieldGet(this,Te,"m",nt).call(this)})),pt.set(this,(i=>{var s,r,n,a,l;__classPrivateFieldGet(this,He,"f").info("onClickCandidate",{evt:i}),i.preventDefault(),i.stopPropagation();const d=i.target.innerText;(null===(s=this.jiix)||void 0===s?void 0:s.words)&&d!==(null===(r=this.wordToChange)||void 0===r?void 0:r.label)&&(null===(a=null===(n=this.wordToChange)||void 0===n?void 0:n.candidates)||void 0===a?void 0:a.includes(d))&&(this.jiix.words[parseInt(null===(l=this.wordToChange)||void 0===l?void 0:l.id)].label=d,this.internalEvent.emitImportJIIX(this.jiix)),__classPrivateFieldGet(this,Oe,"f").style.display="none"})),vt.set(this,(i=>{__classPrivateFieldGet(this,He,"f").info("onClickPrompter",{evt:i}),i.preventDefault(),i.stopPropagation(),__classPrivateFieldGet(this,Te,"m",nt).call(this);const s=i.target;s.id!==__classPrivateFieldGet(this,Ae,"f").id?__classPrivateFieldGet(this,it,"f").call(this,s):__classPrivateFieldGet(this,Te,"m",st).call(this)})),ut.set(this,(i=>{i.preventDefault(),i.stopPropagation()})),ft.set(this,(()=>{__classPrivateFieldGet(this,Te,"m",st).call(this),__classPrivateFieldGet(this,Te,"m",nt).call(this)})),__classPrivateFieldGet(this,He,"f").info("constructor"),this.uuid=createUUID(),this.margin={bottom:0,left:0,right:0,top:0},__classPrivateFieldGet(this,Te,"m",Be).call(this),__classPrivateFieldGet(this,Te,"m",Ve).call(this),__classPrivateFieldGet(this,Te,"m",Je).call(this),__classPrivateFieldGet(this,Te,"m",Xe).call(this),__classPrivateFieldGet(this,Te,"m",qe).call(this),__classPrivateFieldGet(this,Te,"m",Ye).call(this),__classPrivateFieldGet(this,Te,"m",Ze).call(this),__classPrivateFieldGet(this,Te,"m",Ke).call(this),__classPrivateFieldGet(this,Te,"m",Qe).call(this),__classPrivateFieldGet(this,Te,"m",et).call(this),__classPrivateFieldGet(this,Te,"m",tt).call(this)}get internalEvent(){return InternalEvent.getInstance()}init(i,s,r){__classPrivateFieldGet(this,He,"f").info("init",{domElement:i,margin:s,renderingConfiguration:r}),i.appendChild(__classPrivateFieldGet(this,Le,"f")),__classPrivateFieldGet(this,Le,"f").appendChild(__classPrivateFieldGet(this,De,"f")),__classPrivateFieldGet(this,De,"f").appendChild(__classPrivateFieldGet(this,Ne,"f")),__classPrivateFieldGet(this,Re,"f").appendChild(__classPrivateFieldGet(this,Ae,"f")),__classPrivateFieldGet(this,De,"f").appendChild(__classPrivateFieldGet(this,Re,"f")),__classPrivateFieldGet(this,De,"f").appendChild(__classPrivateFieldGet(this,Ie,"f")),__classPrivateFieldGet(this,ze,"f").appendChild(__classPrivateFieldGet(this,je,"f")),__classPrivateFieldGet(this,ze,"f").appendChild(__classPrivateFieldGet(this,We,"f")),__classPrivateFieldGet(this,ze,"f").appendChild(__classPrivateFieldGet(this,Ue,"f")),__classPrivateFieldGet(this,ze,"f").classList.add("close"),__classPrivateFieldGet(this,De,"f").appendChild(__classPrivateFieldGet(this,ze,"f")),__classPrivateFieldSet(this,$e,!1,"f"),__classPrivateFieldGet(this,Oe,"f").style.display="none",__classPrivateFieldGet(this,De,"f").appendChild(__classPrivateFieldGet(this,Oe,"f")),this.margin=s,this.renderingConfiguration=r,__classPrivateFieldGet(this,Te,"m",gt).call(this),this.resize()}resize(){__classPrivateFieldGet(this,He,"f").info("resize");const i=convertMillimeterToPixel(this.margin.left),s=convertMillimeterToPixel(this.margin.right);__classPrivateFieldGet(this,De,"f").style.marginLeft=`${i}px`,__classPrivateFieldGet(this,De,"f").style.marginRight=`${s}px`}update(i){var s,r;__classPrivateFieldGet(this,He,"f").info("update",{exports:i}),this.jiix=i;const createWordSpan=(i,s)=>{const r=document.createElement("span");return r.id=`word-${i}${this.uuid}`,s?r.textContent=s.label:r.innerHTML="&nbsp;",__classPrivateFieldGet(this,He,"f").debug("update",{span:r}),r};(()=>{var i;if(__classPrivateFieldGet(this,He,"f").info("populatePrompter"),__classPrivateFieldGet(this,Ae,"f").innerHTML="",null===(i=this.jiix)||void 0===i?void 0:i.words){const i=this.jiix.words,s=document.createDocumentFragment();i.forEach(((r,n)=>{var a,l,d;if(" "===r.label||r.label.includes("\n"))s.appendChild(createWordSpan(n));else if(n!==i.length-1)s.appendChild(createWordSpan(n,r));else{__classPrivateFieldGet(this,Ae,"f").appendChild(s),this.lastWord&&(this.lastWord=r);const i=createWordSpan(n,r);(null===(a=this.lastWord)||void 0===a?void 0:a.candidates)!==r.candidates&&(null===(l=this.lastWord)||void 0===l?void 0:l.label)!==r.label&&(this.lastWord=r),(null===(d=this.wordToChange)||void 0===d?void 0:d.id)===n.toString()?(i.classList.add("modified-word"),this.wordToChange=void 0):i.classList.add("added-word"),__classPrivateFieldGet(this,Ae,"f").appendChild(i),__classPrivateFieldGet(this,Re,"f").scrollLeft=i.offsetLeft,__classPrivateFieldGet(this,He,"f").debug("update => populatePrompter",{span:i,lastWord:this.lastWord})}}))}})(),(null===(r=null===(s=this.jiix)||void 0===s?void 0:s.words)||void 0===r?void 0:r.length)?__classPrivateFieldGet(this,Ie,"f").style.setProperty("pointer-events","auto"):__classPrivateFieldGet(this,Ie,"f").style.setProperty("pointer-events","none")}clear(){__classPrivateFieldGet(this,He,"f").info("clear"),__classPrivateFieldGet(this,Ae,"f").innerHTML="",__classPrivateFieldGet(this,Oe,"f").innerHTML=""}destroy(){__classPrivateFieldGet(this,He,"f").info("destroy"),__classPrivateFieldGet(this,Te,"m",mt).call(this),__classPrivateFieldGet(this,Le,"f").remove()}}Le=new WeakMap,De=new WeakMap,Re=new WeakMap,Ae=new WeakMap,Ie=new WeakMap,Ne=new WeakMap,Oe=new WeakMap,ze=new WeakMap,je=new WeakMap,We=new WeakMap,Ue=new WeakMap,$e=new WeakMap,He=new WeakMap,it=new WeakMap,ot=new WeakMap,at=new WeakMap,ct=new WeakMap,ht=new WeakMap,pt=new WeakMap,vt=new WeakMap,ut=new WeakMap,ft=new WeakMap,Te=new WeakSet,Be=function _SmartGuide_createRootElement(){__classPrivateFieldSet(this,Le,document.createElement("div"),"f"),__classPrivateFieldGet(this,Le,"f").id=`smartguide-${this.uuid}`,__classPrivateFieldGet(this,Le,"f").classList.add("smartguide")},Ve=function _SmartGuide_createWrapperElement(){__classPrivateFieldSet(this,De,document.createElement("div"),"f"),__classPrivateFieldGet(this,De,"f").id=`smartguide-wrapper-${this.uuid}`,__classPrivateFieldGet(this,De,"f").classList.add("smartguide-wrapper")},Je=function _SmartGuide_createPrompterContainerElement(){__classPrivateFieldSet(this,Re,document.createElement("div"),"f"),__classPrivateFieldGet(this,Re,"f").id=`prompter-container-${this.uuid}`,__classPrivateFieldGet(this,Re,"f").classList.add("prompter-container")},Xe=function _SmartGuide_createPrompterTextElement(){__classPrivateFieldSet(this,Ae,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ae,"f").id=`prompter-text-${this.uuid}`,__classPrivateFieldGet(this,Ae,"f").classList.add("prompter-text"),__classPrivateFieldGet(this,Ae,"f").setAttribute("touch-action","none")},qe=function _SmartGuide_createEllipsisElement(){__classPrivateFieldSet(this,Ie,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ie,"f").id=`ellipsis-${this.uuid}`,__classPrivateFieldGet(this,Ie,"f").classList.add("ellipsis"),__classPrivateFieldGet(this,Ie,"f").innerHTML="..."},Ye=function _SmartGuide_createTagElement(){__classPrivateFieldSet(this,Ne,document.createElement("div"),"f"),__classPrivateFieldGet(this,Ne,"f").id=`tag-icon-${this.uuid}`,__classPrivateFieldGet(this,Ne,"f").classList.add("tag-icon"),__classPrivateFieldGet(this,Ne,"f").innerHTML="&#182;"},Ze=function _SmartGuide_createCandidatesElement(){__classPrivateFieldSet(this,Oe,document.createElement("div"),"f"),__classPrivateFieldGet(this,Oe,"f").id=`candidates-${this.uuid}`,__classPrivateFieldGet(this,Oe,"f").classList.add("candidates")},Ke=function _SmartGuide_createMoreMenuElement(){__classPrivateFieldSet(this,ze,document.createElement("div"),"f"),__classPrivateFieldGet(this,ze,"f").id=`more-menu-${this.uuid}`,__classPrivateFieldGet(this,ze,"f").classList.add("more-menu")},Qe=function _SmartGuide_createConvertElement(){__classPrivateFieldSet(this,je,document.createElement("button"),"f"),__classPrivateFieldGet(this,je,"f").id=`convert-${this.uuid}`,__classPrivateFieldGet(this,je,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,je,"f").innerHTML="Convert"},et=function _SmartGuide_createCopyElement(){__classPrivateFieldSet(this,We,document.createElement("button"),"f"),__classPrivateFieldGet(this,We,"f").id=`copy-${this.uuid}`,__classPrivateFieldGet(this,We,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,We,"f").innerHTML="Copy"},tt=function _SmartGuide_createDeleteElement(){__classPrivateFieldSet(this,Ue,document.createElement("button"),"f"),__classPrivateFieldGet(this,Ue,"f").id=`delete-${this.uuid}`,__classPrivateFieldGet(this,Ue,"f").classList.add("options-label-button"),__classPrivateFieldGet(this,Ue,"f").innerHTML="Delete"},st=function _SmartGuide_hideCandidates(){__classPrivateFieldGet(this,Oe,"f").style.display="none"},rt=function _SmartGuide_openMenu(){__classPrivateFieldGet(this,ze,"f").classList.add("open"),__classPrivateFieldGet(this,ze,"f").classList.remove("close"),__classPrivateFieldSet(this,$e,!0,"f")},nt=function _SmartGuide_closeMenu(){__classPrivateFieldGet(this,ze,"f").classList.add("close"),__classPrivateFieldGet(this,ze,"f").classList.remove("open"),__classPrivateFieldSet(this,$e,!1,"f")},lt=function _SmartGuide_createTextAreaElement(i){const s="rtl"===document.documentElement.getAttribute("dir"),r=document.createElement("textarea");r.style.fontSize="12pt",r.style.display="absolute",r.style[s?"right":"left"]="-9999px";const n=window.pageYOffset||document.documentElement.scrollTop;return r.style.top=`${n}px`,r.setAttribute("readonly",""),r.value=i,r},dt=function _SmartGuide_selectText(i){if(navigator.userAgent.match(/ipad|iphone/i)){const s=document.createRange();s.selectNodeContents(i);const r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(s),i.setSelectionRange(0,999999))}else i.select()},gt=function _SmartGuide_addListeners(){__classPrivateFieldGet(this,Le,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ut,"f").bind(this)),__classPrivateFieldGet(this,Ie,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ot,"f").bind(this)),__classPrivateFieldGet(this,je,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,at,"f").bind(this)),__classPrivateFieldGet(this,We,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ct,"f").bind(this)),__classPrivateFieldGet(this,Ue,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ht,"f").bind(this)),__classPrivateFieldGet(this,Ae,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,vt,"f").bind(this)),__classPrivateFieldGet(this,Oe,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,pt,"f").bind(this)),document.addEventListener("pointerdown",__classPrivateFieldGet(this,ft,"f").bind(this))},mt=function _SmartGuide_removeListeners(){__classPrivateFieldGet(this,Le,"f").addEventListener("pointerdown",__classPrivateFieldGet(this,ut,"f")),__classPrivateFieldGet(this,Ie,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ot,"f")),__classPrivateFieldGet(this,je,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,at,"f")),__classPrivateFieldGet(this,We,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ct,"f")),__classPrivateFieldGet(this,Ue,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,ht,"f")),__classPrivateFieldGet(this,Ae,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,vt,"f")),__classPrivateFieldGet(this,Oe,"f").removeEventListener("pointerdown",__classPrivateFieldGet(this,pt,"f")),document.removeEventListener("pointerdown",__classPrivateFieldGet(this,ft,"f"))};Pt=new WeakMap,yt=new WeakMap,xt=new WeakMap,wt=new WeakMap,bt=new WeakMap,St=new WeakMap,Lt=new WeakMap,Dt=new WeakMap,_t=new WeakSet,Ft=function _Editor_instantiateBehaviors(i){var s;if(this.logger.info("instantiateBehaviors",{options:i}),!(null==i?void 0:i.configuration))throw new Error("Configuration required");let r;this.internalEvents.removeAllListeners(),__classPrivateFieldGet(this,xt,"f")&&__classPrivateFieldGet(this,xt,"f").destroy(),r="REST"===(null===(s=i.configuration.server)||void 0===s?void 0:s.protocol)?new RestBehaviors(i):new WSBehaviors(i),__classPrivateFieldSet(this,xt,Object.assign(r,i.behaviors),"f"),this.logger.debug("instantiateBehaviors",__classPrivateFieldGet(this,xt,"f"))},Gt=function _Editor_initializeBehaviors(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("initializeBehaviors","start"),__classPrivateFieldSet(this,bt,new DeferredPromise,"f"),__classPrivateFieldGet(this,Pt,"f").style.display="initial",__classPrivateFieldGet(this,_t,"m",Ct).call(this),this.behaviors.init(this.wrapperHTML).then((()=>__awaiter(this,void 0,void 0,(function*(){this.logger.info("initializeBehaviors","then"),this.wrapperHTML.editor=this,__classPrivateFieldGet(this,bt,"f").resolve(),this.events.emitLoaded()})))).catch((i=>{this.logger.error("initializeBehaviors",i),__classPrivateFieldGet(this,bt,"f").reject(i),__classPrivateFieldGet(this,_t,"m",kt).call(this,i)})).finally((()=>(this.logger.debug("initializeBehaviors","finally"),__classPrivateFieldGet(this,Pt,"f").style.display="none",__classPrivateFieldGet(this,bt,"f").promise)))}))},Et=function _Editor_initializeSmartGuide(){var i;if(null===(i=__classPrivateFieldGet(this,wt,"f"))||void 0===i||i.destroy(),this.logger.info("initializeSmartGuide",{smartGuide:this.configuration.rendering.smartGuide}),this.configuration.rendering.smartGuide.enable){let i;switch(__classPrivateFieldSet(this,wt,new SmartGuide,"f"),this.configuration.recognition.type){case"TEXT":i=this.configuration.recognition.text.margin;break;case"MATH":i=this.configuration.recognition.math.margin;break;default:i={top:20,left:10,right:10,bottom:10}}__classPrivateFieldGet(this,wt,"f").init(this.wrapperHTML,i,this.configuration.rendering)}},Ct=function _Editor_cleanMessage(){__classPrivateFieldGet(this,yt,"f").style.display="none",__classPrivateFieldGet(this,yt,"f").innerHTML=""},kt=function _Editor_showError(i){__classPrivateFieldGet(this,yt,"f").style.display="initial",__classPrivateFieldGet(this,yt,"f").classList.add("error-msg"),__classPrivateFieldGet(this,yt,"f").classList.remove("info-msg"),__classPrivateFieldGet(this,yt,"f").innerText="string"==typeof i?i:i.message},Mt=function _Editor_showNotif(i){__classPrivateFieldGet(this,yt,"f").style.display="initial",__classPrivateFieldGet(this,yt,"f").classList.add("info-msg"),__classPrivateFieldGet(this,yt,"f").classList.remove("error-msg"),__classPrivateFieldGet(this,yt,"f").innerText=i.message,setTimeout((()=>{__classPrivateFieldGet(this,_t,"m",Ct).call(this)}),i.timeout||2500)},Tt=function _Editor_addListeners(){this.internalEvents.addConvertListener(this.convert.bind(this)),this.internalEvents.addClearListener(this.clear.bind(this)),this.internalEvents.addErrorListener(__classPrivateFieldGet(this,_t,"m",kt).bind(this)),this.internalEvents.addImportJIIXListener(__classPrivateFieldGet(this,_t,"m",At).bind(this)),this.internalEvents.addExportedListener(__classPrivateFieldGet(this,_t,"m",Rt).bind(this)),this.internalEvents.addNotifListener(__classPrivateFieldGet(this,_t,"m",Mt).bind(this)),this.internalEvents.addClearMessageListener(__classPrivateFieldGet(this,_t,"m",Ct).bind(this)),this.internalEvents.addContextChangeListener(__classPrivateFieldGet(this,Lt,"f").bind(this)),this.internalEvents.addIdleListener(__classPrivateFieldGet(this,Dt,"f").bind(this))},Rt=function _Editor_onExport(i){var s;if(this.logger.info("onExport",{exports:i}),this.configuration.rendering.smartGuide.enable&&i&&i["application/vnd.myscript.jiix"]){const r=i["application/vnd.myscript.jiix"];null===(s=__classPrivateFieldGet(this,wt,"f"))||void 0===s||s.update(r)}this.events.emitExported(i)},At=function _Editor_onImportJIIX(i){this.logger.info("onImportJIIX",{jiix:i}),this.import(new Blob([JSON.stringify(i)],{type:"application/vnd.myscript.jiix"}),"application/vnd.myscript.jiix")},i.AbstractSymbol=AbstractSymbol,i.CanvasRenderer=CanvasRenderer,i.CanvasRendererShape=CanvasRendererShape,i.CanvasRendererStroke=CanvasRendererStroke,i.CanvasRendererText=CanvasRendererText,i.Configuration=Configuration,i.DefaultConfiguration=L,i.DefaultConvertionConfiguration=b,i.DefaultDebugConfiguration=P,i.DefaultDiagramConfiguration=c,i.DefaultDiagramConvertConfiguration=d,i.DefaultEraserConfiguration=l,i.DefaultExportConfiguration=p,i.DefaultGrabberConfiguration=a,i.DefaultGuidesConfiguration=F,i.DefaultJiixConfiguration=h,i.DefaultListenerConfiguration=n,i.DefaultLoggerConfiguration=D,i.DefaultMarginConfiguration=v,i.DefaultMathConfiguration=g,i.DefaultMathUndoRedoConfiguration=f,i.DefaultPenStyle=ee,i.DefaultRawContentConfiguration=_,i.DefaultRawContentRecognitionConfiguration=m,i.DefaultRecognitionConfiguration=S,i.DefaultRecognitionRendererConfiguration=y,i.DefaultRenderingConfiguration=E,i.DefaultServerConfiguration=C,i.DefaultSmartGuidesConfiguration=G,i.DefaultSolverConfiguration=u,i.DefaultTextConfiguration=w,i.DefaultTextGuidesConfiguration=x,i.DefaultTheme=te,i.DefaultTriggerConfiguration=k,i.DefaultUndoRedoConfiguration=M,i.DeferredPromise=DeferredPromise,i.Editor=class Editor{constructor(i,s,r="ms-editor"){_t.add(this),this.logger=LoggerManager.getLogger("EDITOR"),Pt.set(this,void 0),yt.set(this,void 0),xt.set(this,void 0),wt.set(this,void 0),bt.set(this,void 0),St.set(this,void 0),Lt.set(this,(i=>{this.events.emitChanged(i)})),Dt.set(this,(i=>{this.events.emitIdle(i)})),__classPrivateFieldSet(this,bt,new DeferredPromise,"f"),this.loggerConfiguration=mergeDeep({},s.logger,D),this.logger.info("constructor",{wrapperHTML:i,options:s,globalClassCss:r}),this.wrapperHTML=i,this.wrapperHTML.classList.add(r),this.wrapperHTML.classList.add("draw"),this.events.setElement(this.wrapperHTML);const n=document.createElement("style");n.appendChild(document.createTextNode(".ms-editor{color:#1a9fff;font-family:sans-serif;position:relative;z-index:10}.ms-editor.draw{cursor:url(\"data:image/svg+xml;charset=utf-8,%3Csvg width='25' height='25' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg filter='url(%23a)'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M5.437 16.033c-.09.394-.167.723-.203.989-.037.27-.045.551.061.818a1.5 1.5 0 0 0 .836.836c.267.106.547.098.818.061.266-.036.595-.112.989-.203l1.23-.284.039-.009c.296-.068.5-.115.695-.196.172-.072.336-.163.488-.27.171-.123.32-.271.535-.486l.028-.028 8.982-8.982c.285-.285.52-.52.695-.727.183-.215.33-.432.415-.691.13-.402.13-.835 0-1.236-.085-.26-.232-.477-.415-.692-.176-.207-.41-.442-.695-.726l-.17-.171a13.38 13.38 0 0 0-.727-.695c-.215-.183-.433-.33-.692-.415a2 2 0 0 0-1.236 0c-.259.084-.476.232-.691.415-.207.176-.442.41-.727.695L6.71 13.018l-.028.028c-.215.215-.363.364-.485.535a2.499 2.499 0 0 0-.27.488c-.082.194-.129.4-.197.695l-.009.039-.284 1.23Z' fill='%23fff'/%3E%3C/g%3E%3Cpath d='m19.425 4.404.142.142c.594.594.89.89 1.002 1.233a1.5 1.5 0 0 1 0 .927c-.111.343-.408.64-1.002 1.234L18.436 9.07l-7.837 7.836c-.241.242-.362.363-.499.46a1.997 1.997 0 0 1-.39.216c-.155.065-.321.103-.654.18l-1.207.278c-.828.191-1.241.287-1.532.17a1 1 0 0 1-.557-.557c-.117-.29-.021-.704.17-1.531l.278-1.208c.077-.333.116-.499.18-.654.057-.138.13-.268.216-.39.098-.137.218-.258.46-.5L14.9 5.537l1.131-1.132c.594-.594.891-.89 1.234-1.002a1.5 1.5 0 0 1 .927 0c.342.111.64.408 1.233 1.002Z' fill='%23fff'/%3E%3Cpath d='m18.436 9.071 1.13-1.131c.595-.594.892-.891 1.003-1.234a1.5 1.5 0 0 0 0-.927c-.111-.342-.408-.64-1.002-1.233l-.142-.142c-.594-.594-.89-.89-1.233-1.002a1.5 1.5 0 0 0-.927 0c-.343.111-.64.408-1.234 1.002L14.9 5.536m3.536 3.535-7.837 7.836c-.241.242-.362.363-.499.46a1.997 1.997 0 0 1-.39.216c-.155.065-.321.103-.654.18l-1.207.278c-.828.191-1.241.287-1.532.17a1 1 0 0 1-.557-.557c-.117-.29-.021-.704.17-1.531l.278-1.208c.077-.333.116-.499.18-.654.057-.138.13-.268.216-.39.098-.137.218-.258.46-.5L14.9 5.537m3.536 3.535L14.9 5.536' stroke='%23000' stroke-linejoin='round'/%3E%3Cdefs%3E%3Cfilter id='a' x='.506' y='0' width='24.465' height='24.465' filterUnits='userSpaceOnUse' color-interpolation-filters='sRGB'%3E%3CfeFlood flood-opacity='0' result='BackgroundImageFix'/%3E%3CfeColorMatrix in='SourceAlpha' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0'/%3E%3CfeOffset dy='1'/%3E%3CfeGaussianBlur stdDeviation='1.5'/%3E%3CfeColorMatrix values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.35 0'/%3E%3CfeBlend in2='BackgroundImageFix' result='effect1_dropShadow'/%3E%3CfeBlend in='SourceGraphic' in2='effect1_dropShadow' result='shape'/%3E%3C/filter%3E%3C/defs%3E%3C/svg%3E\") 5.5 19.5,crosshair}.ms-editor.draw.shape{cursor:crosshair}.ms-editor.erase{cursor:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAEsSURBVDiNrdO7SgNBFMbx/3fmCbQ1tunDIayFBvFSKxbxBfSdBPEBtLIWb3Ebl4R9AQWLkE70CWbHZl1Eg2iSr5vL+c1hhhFTMhwOdyX1gQ2gVU+PgTyldNHtdq+/1+jroCiKtpmdSupNO6ApkgZmdtzpdJ5+QGVZ9qqqugSWfkO+5F3SnrvnDVQURTuE8PgP5DNvkjJ3fzaAEMLJDAjAclVVZwCqL/ZqBqSJme2YpMN5EIAYY9+A9XkhST0DVuaFgJYtAAGoDJgsAJoYkM+rSHqwlNL5Ajq6EMBoNLoBtmbsZuDumwYQYzwCXmdw3oAjAAPIsuxF0kG98GdE0r67PzcQgLvnIYQ14P4PyF39WZuH0rRdZVluxxj7kjaA1Xp6nFLKzezc3W+/13wAItdV6XjME1AAAAAASUVORK5CYII=\") 10 10,auto}.ms-editor.select{cursor:default}.ms-editor.select [type=stroke]{cursor:pointer}.ms-editor canvas,.ms-editor svg{height:100%;left:0;position:absolute;top:0;width:100%;z-index:20}.ms-editor canvas.ms-rendering-canvas{background-image:linear-gradient(90deg,#f5f6f7 1px,transparent 0),linear-gradient(180deg,#f5f6f7 1px,transparent 0);background-size:18px 18px;pointer-events:none;z-index:9}.ms-editor .loader{-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite;border:16px solid #f5f6f7;border-radius:50%;border-top-color:#1a9fff;height:120px;left:calc(50% - 60px);position:absolute;top:calc(50% - 60px);width:120px;z-index:30}.ms-editor .message{word-wrap:break-word;font-size:16px;left:calc(50% - 150px);max-height:25%;min-height:200px;position:absolute;text-align:center;top:calc(50% - 100px);width:300px;z-index:25}.ms-editor .message.error-msg:before{content:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgNzYuNSA2MTIgNDU5IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWluWU1pbiBtZWV0Ij48cGF0aCBmaWxsPSIjMUE5RkZGIiBkPSJNNDk0LjcgMjI5LjVjLTE3Ljg1MS04Ni43LTk0LjM1MS0xNTMtMTg4LjctMTUzLTM4LjI1IDAtNzMuOTUgMTAuMi0xMDIgMzAuNmwzOC4yNSAzOC4yNWMxNy44NS0xMi43NSA0MC44LTE3Ljg1IDYzLjc1LTE3Ljg1IDc2LjUgMCAxNDAuMjUgNjMuNzUgMTQwLjI1IDE0MC4yNXYxMi43NWgzOC4yNWM0My4zNSAwIDc2LjUgMzMuMTUgNzYuNSA3Ni41IDAgMjguMDUtMTUuMyA1My41NS00MC44IDY2LjNsMzguMjUgMzguMjVDNTkxLjYgNDM4LjYgNjEyIDQwMC4zNSA2MTIgMzU3YzAtNjYuMy01My41NS0xMjIuNC0xMTcuMy0xMjcuNXpNNzYuNSAxMDkuNjVsNzEuNCA2OC44NUM2Ni4zIDE4My42IDAgMjQ5LjkgMCAzMzEuNWMwIDg0LjE1IDY4Ljg1IDE1MyAxNTMgMTUzaDI5OC4zNWw1MSA1MSAzMy4xNS0zMy4xNUwxMDkuNjUgNzYuNSA3Ni41IDEwOS42NXpNMTk2LjM1IDIyOS41bDIwNCAyMDRIMTUzYy01Ni4xIDAtMTAyLTQ1LjktMTAyLTEwMnM0NS45LTEwMiAxMDItMTAyaDQzLjM1eiIvPjwvc3ZnPg==\")}.ms-editor .message.info-msg:before{background-image:url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMUE5RkZGIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz48cGF0aCBkPSJNMTIgMTZ2LTRNMTIgOGguMDEiLz48L3N2Zz4=\");background-size:100% 100%;content:\"\";display:block;height:25px;margin:auto;padding-bottom:10px;width:25px}.ms-editor .smartguide{box-shadow:2px 2px 12px #bdbdbd;cursor:default;font-size:16px;left:0;line-height:48px;padding-bottom:12px;padding-top:12px;position:absolute;top:0;width:100%;z-index:40}.ms-editor .smartguide .smartguide-wrapper{border-bottom:1px solid #959da6;display:flex}.ms-editor .smartguide .tag-icon{border-left:1px solid #959da6;border-right:1px solid #959da6;border-top:1px solid #959da6;font-size:large;height:100%;line-height:48px;padding:0 18px;z-index:31}.ms-editor .smartguide .ellipsis,.ms-editor .smartguide .tag-icon{background-color:hsla(0,0%,100%,.9);color:#959da6;font-weight:700;height:48px;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:48px}.ms-editor .smartguide .ellipsis{-webkit-tap-highlight-color:transparent;cursor:pointer;font-size:x-large;line-height:38px;padding:0 8px}.ms-editor .smartguide .ellipsis:active{background-color:#e0e0e0}.ms-editor .smartguide .prompter-container{-webkit-tap-highlight-color:transparent;background-color:hsla(0,0%,100%,.9);color:#bfbfbf;display:block;height:48px;line-height:48px;overflow:hidden;text-align:left;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;width:calc(100% - 96px)}.ms-editor .smartguide .prompter-container>div>span{cursor:pointer;display:inline-block}.ms-editor .smartguide .prompter-container .prompter-text{margin-left:12px}.ms-editor .smartguide .prompter-container .prompter-text .added-word{animation:word-added .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .prompter-container .prompter-text .modified-word{animation:word-modified .1s linear,color-input 3s ease-in-out}.ms-editor .smartguide .candidates{-webkit-tap-highlight-color:transparent;background-color:#f5f5f5;border-radius:3px;box-shadow:2px 2px 12px #bdbdbd,-2px 2px 12px #bdbdbd;color:#000;flex-direction:column;line-height:30px;position:absolute;text-align:center;z-index:100}.ms-editor .smartguide .candidates>span{cursor:pointer;padding:2px 20px}.ms-editor .smartguide .candidates>span:hover{background-color:#eee}.ms-editor .smartguide .candidates>span:active{background-color:#e0e0e0}.ms-editor .smartguide .candidates .selected-word{background-color:#e0e0e0;font-weight:700}.ms-editor .smartguide .more-menu{background-color:#f5f5f5;border-radius:3px;bottom:0;box-shadow:2px 2px 12px #bdbdbd;display:flex;flex-direction:column;line-height:30px;margin-right:12px;overflow:hidden;position:absolute;right:0;transform:translateY(100%);transition:max-height 1s ease-out,opacity 1s,visibility .5s linear;z-index:100}.ms-editor .smartguide .more-menu.open{max-height:500px;opacity:1;visibility:visible}.ms-editor .smartguide .more-menu.close{max-height:0;opacity:0;visibility:hidden}.ms-editor .smartguide .more-menu .options-label-button{-webkit-tap-highlight-color:transparent;background:transparent;border:none;box-sizing:border-box;color:#000;cursor:pointer;font-size:16px;height:40px;margin:0;outline:none;padding:0 24px}.ms-editor .smartguide .more-menu .options-label-button:hover{background-color:#eee}.ms-editor .smartguide .more-menu .options-label-button:active{background-color:#e0e0e0}.ms-editor .ps__rail-x{top:32px!important}.ms-editor #stroke-panel{word-wrap:break-word;background-color:#fff;border:2px solid #000;bottom:10px;cursor:copy;left:10px;max-height:100px;overflow:auto;padding:5px;position:fixed;right:10px;z-index:999}.ms-editor hr.separator.horizontal{border:none;border-top:1px solid #d3d3d3;margin:5px 0;max-height:1px;max-width:100%;min-height:1px;min-width:100%}.ms-editor hr.separator.vertical{border:none;border-left:1px solid #d3d3d3;margin:0 5px;max-height:100%;max-width:1px;min-height:100%;min-width:1px}.ms-editor .stroke-menu{background-color:#fff;border-radius:12px;box-shadow:2px 2px 10px rgba(0,0,0,.25),-2px -2px 10px rgba(0,0,0,.25);cursor:pointer;cursor:auto;display:flex;gap:2px;padding:5px;position:absolute;width:auto;z-index:999}.ms-editor .stroke-menu-button{background:#f6f5f4;background-color:#fff;border:none;border-radius:4px;cursor:pointer;display:block;font-size:inherit;height:32px;margin:auto;position:relative;width:32px}.ms-editor .stroke-menu-button:hover{background-color:hsla(0,0%,44%,.1)}.ms-editor .stroke-menu-button .tooltip{background-color:#000;bottom:100%;color:#fff}.ms-editor .stroke-menu-button .tooltip,.ms-editor output.tooltip{border-radius:5px;display:none;font-weight:700;left:50%;padding:5px;position:absolute;transform:translate(-50%,-50%);white-space:nowrap;width:auto}.ms-editor output.tooltip{background-color:#fff;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);color:#000;top:0}.ms-editor input:focus+output.tooltip,.ms-editor input:focus-visible+output.tooltip,.ms-editor input:hover+output.tooltip{display:block}.ms-editor .stroke-menu-button:focus .tooltip,.ms-editor .stroke-menu-button:focus-visible .tooltip,.ms-editor .stroke-menu-button:hover .tooltip{display:block}.ms-editor .stroke-menu-button svg{display:block;position:relative}.ms-editor .stroke-sub-menu{background-color:#fff;border-radius:12px;box-shadow:0 2px 5px 0 rgba(0,0,0,.225);display:none;padding:5px;position:absolute;top:100%;transform:translate(calc(-50% + 16px),12px);width:190px}.ms-editor .stroke-sub-menu.active{display:block}.ms-editor .stroke-sub-menu label{color:#717171;font-weight:700;padding:5px}.ms-editor .stroke-menu-button-color{background-color:rgba(0,0,0,.05);display:flex}.ms-editor .stroke-menu .menu-list{display:flex;flex-wrap:wrap;gap:5px;list-style:none;margin:0;padding:0}.ms-editor .removed-stroke{opacity:0;transition:opacity .1s ease-in-out}.ms-editor .added-stroke{animation:opacity-appear .2s}@keyframes color-input{0%{color:#000}to{color:#bfbfbf}}@keyframes word-added{0%{transform:translate(5px)}to{transform:none}}@keyframes word-modified{0%{transform:translateY(5px)}to{transform:none}}@keyframes opacity-appear{0%{opacity:0}to{opacity:1}}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(1turn)}}")),this.wrapperHTML.appendChild(n),__classPrivateFieldSet(this,Pt,document.createElement("div"),"f"),__classPrivateFieldGet(this,Pt,"f").classList.add("loader"),__classPrivateFieldGet(this,Pt,"f").style.display="none",this.wrapperHTML.appendChild(__classPrivateFieldGet(this,Pt,"f")),__classPrivateFieldSet(this,yt,document.createElement("div"),"f"),__classPrivateFieldGet(this,yt,"f").classList.add("message"),__classPrivateFieldGet(this,yt,"f").style.display="none",this.wrapperHTML.appendChild(__classPrivateFieldGet(this,yt,"f")),__classPrivateFieldGet(this,_t,"m",Ft).call(this,s)}get loggerConfiguration(){return __classPrivateFieldGet(this,St,"f")}set loggerConfiguration(i){__classPrivateFieldSet(this,St,Object.assign({},D,i),"f"),LoggerManager.setLoggerLevel(__classPrivateFieldGet(this,St,"f"))}get initializationPromise(){return __classPrivateFieldGet(this,bt,"f").promise}get model(){return this.behaviors.model}get behaviors(){return __classPrivateFieldGet(this,xt,"f")}get configuration(){return this.behaviors.configuration}set configuration(i){this.logger.info("set configuration",{configuration:i}),__classPrivateFieldGet(this,_t,"m",Ft).call(this,{configuration:i}),this.initialize()}get intention(){return this.behaviors.intention}set intention(i){if(this.behaviors.intention=i,"erase"===this.behaviors.intention)this.wrapperHTML.classList.remove("draw"),this.wrapperHTML.classList.add("erase"),this.wrapperHTML.classList.remove("select");else this.wrapperHTML.classList.add("draw"),this.wrapperHTML.classList.remove("erase"),this.wrapperHTML.classList.remove("select");this.logger.debug("set intention",this.wrapperHTML)}get events(){return PublicEvent.getInstance()}get internalEvents(){return InternalEvent.getInstance()}get context(){return this.behaviors.context}get grabber(){return this.behaviors.grabber}get currentPenStyle(){return this.behaviors.currentPenStyle}get penStyle(){return this.behaviors.penStyle}set penStyle(i){this.logger.info("set penStyle",{ps:i}),this.behaviors.setPenStyle(i)}get theme(){return this.behaviors.theme}set theme(i){this.logger.info("set theme",{t:i}),this.behaviors.setTheme(i)}get penStyleClasses(){return this.behaviors.penStyleClasses}set penStyleClasses(i){this.logger.info("set penStyleClasses",{psc:i}),this.behaviors.setPenStyleClasses(i)}get gestures(){return this.configuration.recognition.gesture.enable}set gestures(i){this.configuration.recognition.gesture.enable=i,__classPrivateFieldGet(this,_t,"m",Ft).call(this,{configuration:this.configuration}),this.initialize()}initialize(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("initialize"),yield __classPrivateFieldGet(this,_t,"m",Gt).call(this),__classPrivateFieldGet(this,_t,"m",Et).call(this),__classPrivateFieldGet(this,_t,"m",Tt).call(this)}))}waitForIdle(){return __awaiter(this,void 0,void 0,(function*(){if(this.behaviors.waitForIdle)return this.behaviors.waitForIdle()}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("undo"),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.undo(),this.logger.debug("undo",this.model),this.model}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("redo"),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.redo(),this.logger.debug("redo",this.model),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("clear"),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.clear(),this.events.emitCleared(this.model),this.logger.debug("clear",this.model),this.model}))}resize(){var i;return __awaiter(this,void 0,void 0,(function*(){this.logger.info("resize"),yield __classPrivateFieldGet(this,bt,"f").promise,this.configuration.rendering.smartGuide.enable&&(null===(i=__classPrivateFieldGet(this,wt,"f"))||void 0===i||i.resize());const s=window.getComputedStyle(this.wrapperHTML),r=Math.max(parseInt(s.height.replace("px","")),this.configuration.rendering.minHeight),n=Math.max(parseInt(s.width.replace("px","")),this.configuration.rendering.minWidth);return yield this.behaviors.resize(r,n),this.logger.debug("resize",this.model),this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{mimeTypes:i}),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.export(i),this.logger.debug("export",this.model),this.model}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("export",{params:i}),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.convert(null==i?void 0:i.conversionState,null==i?void 0:i.mimeTypes),this.events.emitConverted(this.model.converts),this.logger.debug("convert",this.model),this.model}))}import(i,s){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("import",{data:i,mimeType:s}),yield __classPrivateFieldGet(this,bt,"f").promise,this.behaviors.import){let r;return r=i instanceof Blob?i:"string"==typeof i?new Blob([i]):new Blob([JSON.stringify(i)]),yield this.behaviors.import(r,s),this.events.emitImported(this.model.exports),this.logger.debug("import",this.model),this.model}return Promise.reject("Import impossible, behaviors has no import function")}))}importPointEvents(i){return __awaiter(this,void 0,void 0,(function*(){return this.logger.info("importPointEvents",{strokes:i}),yield __classPrivateFieldGet(this,bt,"f").promise,yield this.behaviors.importPointEvents(i),this.events.emitImported(this.model.exports),this.logger.debug("importPointEvents",this.model),this.model}))}},i.Error=R,i.EventType=A,i.InternalEvent=InternalEvent,i.InternalEventType=I,i.Logger=Logger,i.LoggerManager=LoggerManager,i.Model=Model,i.PointerEventGrabber=PointerEventGrabber,i.PublicEvent=PublicEvent,i.RestBehaviors=RestBehaviors,i.RestRecognizer=RestRecognizer,i.SVGStroker=SVGStroker,i.SmartGuide=SmartGuide,i.Stroke=Stroke,i.StyleHelper=ne,i.StyleManager=StyleManager,i.UndoRedoContext=UndoRedoContext,i.UndoRedoManager=UndoRedoManager,i.WSBehaviors=WSBehaviors,i.WSRecognizer=WSRecognizer,i.WSSVGRenderer=WSSVGRenderer,i.computeAngleAxeRadian=computeAngleAxeRadian,i.computeDistance=computeDistance,i.computeDistanceBetweenPointAndSegment=function computeDistanceBetweenPointAndSegment(i,s){return computeDistance(i,computeNearestPointOnSegment(i,s))},i.computeHmac=computeHmac,i.computeLinksPointers=computeLinksPointers,i.computeMiddlePointer=computeMiddlePointer,i.computeNearestPointOnSegment=computeNearestPointOnSegment,i.convertMillimeterToPixel=convertMillimeterToPixel,i.convertPartialStrokesToStrokes=function convertPartialStrokesToStrokes(i){const s=[],r=[];if(i.forEach(((i,n)=>{var a,l;let d=!0;const c=new Stroke(i.style||ee,i.pointerId||1);if(i.id&&(c.id=i.id),!(null===(a=i.pointers)||void 0===a?void 0:a.length))return s.push(`stroke ${n+1} has not pointers`),void(d=!1);null===(l=i.pointers)||void 0===l||l.forEach(((i,r)=>{if(!i)return s.push(`stroke ${n+1} has no pointer at ${r}`),void(d=!1);const a={p:i.p||1,t:i.t||r,x:0,y:0};return null==(null==i?void 0:i.x)||null==(null==i?void 0:i.x)?(s.push(`stroke ${n+1} has no x at pointer at ${r}`),void(d=!1)):(a.x=i.x,null==(null==i?void 0:i.y)||null==(null==i?void 0:i.y)?(s.push(`stroke ${n+1} has no y at pointer at ${r}`),void(d=!1)):(a.y=i.y,void(d&&c.pointers.push(a))))})),d&&r.push(c)})),s.length)throw new Error(s.join("\n"));return r},i.convertPixelToMillimeter=function convertPixelToMillimeter(i){return i/96*25.4},i.createPointsOnSegment=function createPointsOnSegment(i,s,r=1){const n=[],a=computeDistance(i,s);let l=r;for(;l<a;){const d={x:i.x+l*(s.x-i.x)/a,y:i.y+l*(s.y-i.y)/a};n.push(d),l+=r}return n},i.createUUID=createUUID,i.getAvailableFontList=function getAvailableFontList(i){var s,r,n;return __awaiter(this,void 0,void 0,(function*(){if(!(null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.scheme)&&!(null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.host))return Promise.reject("Failed to get fonts: configuration.server.scheme & configuration.server.host are required!");if(!(null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.lang))return Promise.reject("Failed to get fonts: configuration.recognition.lang is required!");const a=i.server,l=yield fetch(`${a.scheme}://${a.host}/api/v4.0/iink/font/google/language/`+i.recognition.lang),{result:d}=yield l.json();return d.sort()}))},i.getAvailableLanguageList=function getAvailableLanguageList(i){var s,r;return __awaiter(this,void 0,void 0,(function*(){if((null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.scheme)&&(null===(r=null==i?void 0:i.server)||void 0===r?void 0:r.host)){const s=i.server;return(yield fetch(`${s.scheme}://${s.host}/api/v4.0/iink/availableLanguageList`)).json()}return Promise.reject("Failed to get languages: configuration.server.scheme & configuration.server.host are required!")}))},i.isBetween=function isBetween(i,s,r){return i>=s&&i<=r},i.isVersionSuperiorOrEqual=isVersionSuperiorOrEqual,i.mergeDeep=mergeDeep,i.scalaire=scalaire}));
//# sourceMappingURL=iink.min.js.map
